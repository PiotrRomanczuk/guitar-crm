name: Version Bump

on:
  push:
    branches: [main]

permissions:
  contents: write

concurrency:
  group: version-bump
  cancel-in-progress: false

jobs:
  bump:
    # Skip commits made by this workflow to prevent infinite loops
    if: "!startsWith(github.event.head_commit.message, 'chore: bump version')"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Detect bump type
        id: detect
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"

          # Extract PR number from squash-merge commit message (e.g. "Some title (#123)")
          PR_NUMBER=$(echo "$COMMIT_MSG" | grep -oP '\(#\K[0-9]+(?=\))' | tail -1)

          if [ -z "$PR_NUMBER" ]; then
            echo "No PR number found in commit message — skipping version bump"
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "PR #$PR_NUMBER detected"

          # Get the source branch name from the PR
          BRANCH=$(gh pr view "$PR_NUMBER" --json headRefName --jq '.headRefName')
          echo "Source branch: $BRANCH"

          # Check for label overrides on the PR
          LABELS=$(gh pr view "$PR_NUMBER" --json labels --jq '.labels[].name')

          if echo "$LABELS" | grep -q "version:major"; then
            BUMP_TYPE="major"
          elif echo "$LABELS" | grep -q "version:minor"; then
            BUMP_TYPE="minor"
          elif echo "$LABELS" | grep -q "version:patch"; then
            BUMP_TYPE="patch"
          elif echo "$BRANCH" | grep -qE "^feat(ure)?/"; then
            BUMP_TYPE="minor"
          else
            BUMP_TYPE="patch"
          fi

          echo "Bump type: $BUMP_TYPE"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "bump_type=$BUMP_TYPE" >> "$GITHUB_OUTPUT"
          echo "pr_number=$PR_NUMBER" >> "$GITHUB_OUTPUT"

      - name: Bump version
        if: steps.detect.outputs.skip != 'true'
        run: |
          OLD_VERSION=$(node -p "require('./package.json').version")
          npm version ${{ steps.detect.outputs.bump_type }} --no-git-tag-version
          NEW_VERSION=$(node -p "require('./package.json').version")

          echo "OLD_VERSION=$OLD_VERSION" >> "$GITHUB_ENV"
          echo "NEW_VERSION=$NEW_VERSION" >> "$GITHUB_ENV"

      - name: Commit and push
        if: steps.detect.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "chore: bump version $OLD_VERSION → $NEW_VERSION [PR #${{ steps.detect.outputs.pr_number }}]"
          git push
