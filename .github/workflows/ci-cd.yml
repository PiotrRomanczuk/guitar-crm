name: CI/CD Pipeline

on:
  push:
    branches: [main, production, develop, 'feature/**', 'fix/**', 'copilot/**', 'ci/**']
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL || 'https://example.supabase.co' }}
  NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY || 'mock-key' }}
  SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY || 'mock-key' }}
  SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    outputs:
      has-secrets: ${{ steps.check.outputs.has-secrets }}
    steps:
      - id: check
        run: |
          if [ -n "${{ secrets.SUPABASE_PROJECT_ID }}" ]; then
            echo "has-secrets=true" >> $GITHUB_OUTPUT
          else
            echo "has-secrets=false" >> $GITHUB_OUTPUT
          fi

  backup-database:
    name: Database Backup
    runs-on: ubuntu-latest
    needs: [check-secrets]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/production' || github.ref == 'refs/heads/ci/pipeline-improvements') && github.event_name == 'push' && needs.check-secrets.outputs.has-secrets == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL Client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run Full Backup
        env:
          PGHOST: db.${{ secrets.SUPABASE_PROJECT_ID }}.supabase.co
          PGPORT: 5432
          PGUSER: postgres
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGDATABASE: postgres
        run: |
          chmod +x scripts/database/backup/full-backup.sh
          ./scripts/database/backup/full-backup.sh

      - name: Upload to Google Drive
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          BACKUP_FILE=$(ls backup_*.sql | head -n 1)
          npx ts-node scripts/database/backup/upload-to-drive.ts "$BACKUP_FILE"

      - name: Upload Backup Artifact
        uses: actions/upload-artifact@v4
        with:
          name: database-backup
          path: backup_*.sql
          retention-days: 3
