{"version":3,"sources":["/home/piotr/Desktop/guitar-crm/lib/getUserWithRolesSSR.test.ts"],"sourcesContent":["/**\n * Tests for getUserWithRolesSSR\n * Using development credentials from development_credentials.txt\n */\n\nimport { getUserWithRolesSSR } from '@/lib/getUserWithRolesSSR';\nimport { cookies } from 'next/headers';\nimport { createServerClient } from '@supabase/ssr';\n\n// Mock dependencies\njest.mock('next/headers');\njest.mock('@supabase/ssr');\n\ndescribe('getUserWithRolesSSR', () => {\n  const mockCookieStore = {\n    getAll: jest.fn(),\n    set: jest.fn(),\n    get: jest.fn(),\n  };\n\n  const mockSupabaseClient = {\n    auth: {\n      getUser: jest.fn(),\n    },\n    from: jest.fn(),\n  };\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    (cookies as jest.Mock).mockResolvedValue(mockCookieStore);\n    (createServerClient as jest.Mock).mockReturnValue(mockSupabaseClient);\n  });\n\n  describe('Admin User (p.romanczuk@gmail.com)', () => {\n    it('returns user with admin and teacher roles', async () => {\n      const mockUser = {\n        id: 'admin-user-id',\n        email: 'p.romanczuk@gmail.com',\n        aud: 'authenticated',\n        role: 'authenticated',\n      };\n\n      const mockRoles = [{ role: 'admin' }, { role: 'teacher' }];\n\n      mockSupabaseClient.auth.getUser.mockResolvedValue({\n        data: { user: mockUser },\n        error: null,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({\n            data: mockRoles,\n            error: null,\n          }),\n        }),\n      });\n\n      const result = await getUserWithRolesSSR();\n\n      expect(result).toEqual({\n        user: mockUser,\n        isAdmin: true,\n        isTeacher: true,\n        isStudent: false,\n      });\n    });\n  });\n\n  describe('Teacher User (teacher@example.com)', () => {\n    it('returns user with teacher role only', async () => {\n      const mockUser = {\n        id: 'teacher-user-id',\n        email: 'teacher@example.com',\n        aud: 'authenticated',\n        role: 'authenticated',\n      };\n\n      const mockRoles = [{ role: 'teacher' }];\n\n      mockSupabaseClient.auth.getUser.mockResolvedValue({\n        data: { user: mockUser },\n        error: null,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({\n            data: mockRoles,\n            error: null,\n          }),\n        }),\n      });\n\n      const result = await getUserWithRolesSSR();\n\n      expect(result).toEqual({\n        user: mockUser,\n        isAdmin: false,\n        isTeacher: true,\n        isStudent: false,\n      });\n    });\n  });\n\n  describe('Student User (student@example.com)', () => {\n    it('returns user with student role only', async () => {\n      const mockUser = {\n        id: 'student-user-id',\n        email: 'student@example.com',\n        aud: 'authenticated',\n        role: 'authenticated',\n      };\n\n      const mockRoles = [{ role: 'student' }];\n\n      mockSupabaseClient.auth.getUser.mockResolvedValue({\n        data: { user: mockUser },\n        error: null,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({\n            data: mockRoles,\n            error: null,\n          }),\n        }),\n      });\n\n      const result = await getUserWithRolesSSR();\n\n      expect(result).toEqual({\n        user: mockUser,\n        isAdmin: false,\n        isTeacher: false,\n        isStudent: true,\n      });\n    });\n  });\n\n  describe('No User', () => {\n    it('returns all roles false when no user is authenticated', async () => {\n      mockSupabaseClient.auth.getUser.mockResolvedValue({\n        data: { user: null },\n        error: null,\n      });\n\n      const result = await getUserWithRolesSSR();\n\n      expect(result).toEqual({\n        user: null,\n        isAdmin: false,\n        isTeacher: false,\n        isStudent: false,\n      });\n    });\n  });\n\n  describe('User with No Roles', () => {\n    it('returns user with all roles false', async () => {\n      const mockUser = {\n        id: 'no-roles-user-id',\n        email: 'user@example.com',\n        aud: 'authenticated',\n        role: 'authenticated',\n      };\n\n      mockSupabaseClient.auth.getUser.mockResolvedValue({\n        data: { user: mockUser },\n        error: null,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({\n            data: [], // No roles found\n            error: null,\n          }),\n        }),\n      });\n\n      const result = await getUserWithRolesSSR();\n\n      expect(result).toEqual({\n        user: mockUser,\n        isAdmin: false,\n        isTeacher: false,\n        isStudent: false,\n      });\n    });\n  });\n\n  describe('Database Error', () => {\n    it('returns user with all roles false on error', async () => {\n      const mockUser = {\n        id: 'error-user-id',\n        email: 'error@example.com',\n        aud: 'authenticated',\n        role: 'authenticated',\n      };\n\n      mockSupabaseClient.auth.getUser.mockResolvedValue({\n        data: { user: mockUser },\n        error: null,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockResolvedValue({\n            data: null,\n            error: { message: 'Database error' },\n          }),\n        }),\n      });\n\n      const result = await getUserWithRolesSSR();\n\n      expect(result).toEqual({\n        user: mockUser,\n        isAdmin: false,\n        isTeacher: false,\n        isStudent: false,\n      });\n    });\n  });\n\n  describe('Database Error', () => {\n    it('handles profile fetch error gracefully', async () => {\n      const mockUser = {\n        id: 'user-id',\n        email: 'user@example.com',\n        aud: 'authenticated',\n        role: 'authenticated',\n      };\n\n      mockSupabaseClient.auth.getUser.mockResolvedValue({\n        data: { user: mockUser },\n        error: null,\n      });\n\n      mockSupabaseClient.from.mockReturnValue({\n        select: jest.fn().mockReturnValue({\n          eq: jest.fn().mockReturnValue({\n            single: jest.fn().mockResolvedValue({\n              data: null,\n              error: { code: 'PGRST500', message: 'Database error' },\n            }),\n          }),\n        }),\n      });\n\n      const result = await getUserWithRolesSSR();\n\n      expect(result).toEqual({\n        user: mockUser,\n        isAdmin: false,\n        isTeacher: false,\n        isStudent: false,\n      });\n    });\n  });\n\n  describe('Authentication Error', () => {\n    it('returns null user when auth fails', async () => {\n      mockSupabaseClient.auth.getUser.mockResolvedValue({\n        data: { user: null },\n        error: { message: 'Auth error' },\n      });\n\n      const result = await getUserWithRolesSSR();\n\n      expect(result).toEqual({\n        user: null,\n        isAdmin: false,\n        isTeacher: false,\n        isStudent: false,\n      });\n    });\n  });\n});\n"],"names":["jest","mock","describe","mockCookieStore","getAll","fn","set","get","mockSupabaseClient","auth","getUser","from","beforeEach","clearAllMocks","cookies","mockResolvedValue","createServerClient","mockReturnValue","it","mockUser","id","email","aud","role","mockRoles","data","user","error","select","eq","result","getUserWithRolesSSR","expect","toEqual","isAdmin","isTeacher","isStudent","message","single","code"],"mappings":"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"}