{"version":3,"sources":["/home/piotr/Desktop/guitar-crm/lib/supabase/credentials.test.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { Database } from '@/types/database.types';\nimport dotenv from 'dotenv';\nimport path from 'path';\n\n// Load test environment variables\ndotenv.config({\n  path: path.resolve(process.cwd(), '.env.test'),\n});\n\n// Mock Supabase client\nlet currentRole: { isAdmin: boolean; isTeacher: boolean; isStudent: boolean } | null = null;\n\njest.mock('@supabase/supabase-js', () => ({\n  createClient: jest.fn(() => ({\n    auth: {\n      signInWithPassword: jest.fn(),\n      getUser: jest.fn(),\n    },\n    from: jest.fn(),\n  })),\n}));\n\nconst supabase = createClient<Database>(\n  process.env.NEXT_PUBLIC_SUPABASE_URL || 'http://mock.url',\n  process.env.SUPABASE_SERVICE_ROLE_KEY || 'mock-key'\n);\n\ndescribe('Development Credentials Authentication Tests', () => {\n  // Test credentials from development_credentials.txt\n  const testUsers = [\n    {\n      email: 'p.romanczuk@gmail.com',\n      password: 'test123_admin',\n      role: { isAdmin: true, isTeacher: true, isStudent: false },\n      description: 'Admin & Teacher',\n    },\n    {\n      email: 'teacher@example.com',\n      password: 'test123_teacher',\n      role: { isAdmin: false, isTeacher: true, isStudent: false },\n      description: 'Teacher',\n    },\n    {\n      email: 'student@example.com',\n      password: 'test123_student',\n      role: { isAdmin: false, isTeacher: false, isStudent: true },\n      description: 'Student',\n    },\n    {\n      email: 'teststudent1@example.com',\n      password: 'test123_student',\n      role: { isAdmin: false, isTeacher: false, isStudent: true },\n      description: 'Student 1',\n    },\n    {\n      email: 'teststudent2@example.com',\n      password: 'test123_student',\n      role: { isAdmin: false, isTeacher: false, isStudent: true },\n      description: 'Student 2',\n    },\n    {\n      email: 'teststudent3@example.com',\n      password: 'test123_student',\n      role: { isAdmin: false, isTeacher: false, isStudent: true },\n      description: 'Student 3',\n    },\n  ];\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    // Default mock implementation for auth\n    (supabase.auth.signInWithPassword as jest.Mock).mockImplementation(async ({ email, password }) => {\n      const user = testUsers.find(u => u.email === email);\n      if (user && user.password === password) {\n        currentRole = user.role;\n        return {\n          data: { user: { email, id: 'test-user-id' }, session: {} },\n          error: null,\n        };\n      }\n      return {\n        data: { user: null, session: null },\n        error: { message: 'Invalid login credentials' },\n      };\n    });\n\n    // Default mock implementation for from\n    (supabase.from as jest.Mock).mockImplementation((table) => {\n      const builder = {\n        select: jest.fn().mockReturnThis(),\n        limit: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockReturnThis(),\n        single: jest.fn().mockReturnThis(),\n        then: jest.fn().mockImplementation((resolve) => {\n          // Logic based on table and currentRole\n          if (table === 'task_management') {\n            if (currentRole?.isAdmin) {\n              resolve({ data: [{ id: 1 }], error: null });\n            } else {\n              resolve({ data: null, error: { message: 'Permission denied' } });\n            }\n          } else if (table === 'lessons') {\n             resolve({ data: [{ id: 1 }], error: null });\n          } else if (table === 'profiles') {\n             // Return profile based on currentRole\n             if (currentRole) {\n               resolve({ \n                 data: { \n                   is_admin: currentRole.isAdmin, \n                   is_teacher: currentRole.isTeacher, \n                   is_student: currentRole.isStudent \n                 }, \n                 error: null \n               });\n             } else {\n               resolve({ data: null, error: { message: 'No profile' } });\n             }\n          } else {\n            resolve({ data: [], error: null });\n          }\n        }),\n      };\n      return builder;\n    });\n  });\n\n  describe('Authentication Tests', () => {\n    test.each(testUsers)(\n      'should authenticate successfully: $description',\n      async ({ email, password }) => {\n        const { data, error } = await supabase.auth.signInWithPassword({\n          email,\n          password,\n        });\n\n        expect(error).toBeNull();\n        expect(data.user).not.toBeNull();\n        expect(data.user?.email).toBe(email);\n      }\n    );\n\n    test.each(testUsers)(\n      'should have correct role flags: $description',\n      async ({ email, role }) => {\n        const {\n          data: { user },\n          error,\n        } = await supabase.auth.signInWithPassword({\n          email,\n          password: testUsers.find((u) => u.email === email)?.password || 'fallback',\n        });\n        expect(error).toBeNull();\n        expect(user).not.toBeNull();\n\n        // Check profile roles\n        const { data: profile } = await supabase\n          .from('profiles')\n          .select('is_admin, is_teacher, is_student')\n          .eq('id', user!.id)\n          .single<{ is_admin: boolean; is_teacher: boolean; is_student: boolean }>();\n\n        expect(profile).not.toBeNull();\n        expect(profile?.is_admin).toBe(role.isAdmin);\n        expect(profile?.is_teacher).toBe(role.isTeacher);\n        expect(profile?.is_student).toBe(role.isStudent);\n      }\n    );\n  });\n\n  describe('Invalid Authentication Tests', () => {\n    test.each(testUsers)('should fail with wrong password: $description', async ({ email }) => {\n      const { error } = await supabase.auth.signInWithPassword({\n        email,\n        password: 'wrong_password',\n      });\n\n      expect(error).not.toBeNull();\n      expect(error?.message).toContain('Invalid login credentials');\n    });\n\n    test('should fail with non-existent email', async () => {\n      const { error } = await supabase.auth.signInWithPassword({\n        email: 'nonexistent@example.com',\n        password: 'any_password',\n      });\n\n      expect(error).not.toBeNull();\n      expect(error?.message).toContain('Invalid login credentials');\n    });\n  });\n\n  describe('Role-based Access Tests', () => {\n    test('admin user should have admin access', async () => {\n      await supabase.auth.signInWithPassword({\n        email: 'p.romanczuk@gmail.com',\n        password: 'test123_admin',\n      });\n\n      // Try to access admin-only data\n      const { data: tasks, error } = await supabase.from('task_management').select('*').limit(1);\n\n      expect(error).toBeNull();\n      expect(tasks).not.toBeNull();\n    });\n\n    test('teacher can access their assigned lessons', async () => {\n      const {\n        data: { user },\n      } = await supabase.auth.signInWithPassword({\n        email: 'teacher@example.com',\n        password: 'test123_teacher',\n      });\n\n      const { data: lessons, error } = await supabase\n        .from('lessons')\n        .select('*')\n        .eq('teacher_id', user!.id);\n\n      expect(error).toBeNull();\n      expect(lessons).not.toBeNull();\n    });\n\n    test('student cannot access admin features', async () => {\n      await supabase.auth.signInWithPassword({\n        email: 'student@example.com',\n        password: 'test123_student',\n      });\n\n      // Try to access admin-only data\n      const { data: tasks, error } = await supabase.from('task_management').select('*').limit(1);\n\n      expect(error).not.toBeNull();\n      expect(tasks).toBeNull();\n    });\n  });\n\n  describe('Password Pattern Tests', () => {\n    test.each(testUsers)(\n      'password follows pattern test123_[role]: $description',\n      ({ password, role }) => {\n        if (role.isAdmin) {\n          expect(password).toBe('test123_admin');\n        } else if (role.isTeacher) {\n          expect(password).toBe('test123_teacher');\n        } else if (role.isStudent) {\n          expect(password).toBe('test123_student');\n        }\n      }\n    );\n  });\n});\n"],"names":["jest","mock","createClient","fn","auth","signInWithPassword","getUser","from","dotenv","config","path","resolve","process","cwd","currentRole","supabase","env","NEXT_PUBLIC_SUPABASE_URL","SUPABASE_SERVICE_ROLE_KEY","describe","testUsers","email","password","role","isAdmin","isTeacher","isStudent","description","beforeEach","clearAllMocks","mockImplementation","user","find","u","data","id","session","error","message","table","builder","select","mockReturnThis","limit","eq","single","then","is_admin","is_teacher","is_student","test","each","expect","toBeNull","not","toBe","profile","toContain","tasks","lessons"],"mappings":"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"}