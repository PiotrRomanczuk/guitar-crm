{"version":3,"sources":["/home/piotr/Desktop/guitar-crm/lib/bearer-auth.ts"],"sourcesContent":["/**\n * Bearer token authentication utilities for API routes\n */\n\nimport { createAdminClient } from '@/lib/supabase/admin';\nimport { createClient as createServerClient } from '@/lib/supabase/server';\nimport { hashApiKey } from '@/lib/api-keys';\n\n/**\n * Extract bearer token from Authorization header\n * @param authHeader The Authorization header value\n * @returns {string | null} The token or null if not found\n */\nexport function extractBearerToken(authHeader?: string): string | null {\n  if (!authHeader || !authHeader.startsWith('Bearer ')) {\n    return null;\n  }\n  return authHeader.slice(7);\n}\n\n/**\n * Authenticate a request using bearer token\n * Returns the user ID and profile if authentication succeeds\n * @param bearerToken The bearer token from the Authorization header\n * @returns {Promise<{userId: string, profile: any} | null>} User info or null if authentication fails\n */\nexport async function authenticateWithBearerToken(bearerToken: string) {\n  try {\n    const supabase = createAdminClient();\n    const keyHash = hashApiKey(bearerToken);\n\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const { data: apiKey, error } = await (supabase as unknown as any)\n      .from('api_keys')\n      .select('user_id, is_active')\n      .eq('key_hash', keyHash)\n      .single();\n\n    if (error || !apiKey || !apiKey.is_active) {\n      console.error('[Bearer Auth] Invalid or inactive API key');\n      return null;\n    }\n\n    // Update last_used_at (fire and forget)\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    void (supabase as unknown as any)\n      .from('api_keys')\n      .update({ last_used_at: new Date().toISOString() })\n      .eq('key_hash', keyHash);\n\n    // Get the user's profile\n    const { data: profile, error: profileError } = await supabase\n      .from('profiles')\n      .select('*')\n      .eq('id', apiKey.user_id)\n      .single();\n\n    if (profileError || !profile) {\n      return null;\n    }\n\n    return {\n      userId: apiKey.user_id,\n      profile,\n    };\n  } catch (error) {\n    console.error('[Bearer Auth] Error authenticating:', error);\n    return null;\n  }\n}\n\n/**\n * Authenticate using session cookies (for backward compatibility)\n */\nexport async function authenticateWithSession() {\n  try {\n    const supabase = await createServerClient();\n\n    const {\n      data: { user },\n      error,\n    } = await supabase.auth.getUser();\n\n    if (error || !user) {\n      return null;\n    }\n\n    const { data: profile, error: profileError } = await supabase\n      .from('profiles')\n      .select('*')\n      .eq('id', user.id)\n      .single();\n\n    if (profileError || !profile) {\n      return null;\n    }\n\n    return {\n      userId: user.id,\n      profile,\n    };\n  } catch (error) {\n    console.error('[Session Auth] Error authenticating:', error);\n    return null;\n  }\n}\n"],"names":["authenticateWithBearerToken","authenticateWithSession","extractBearerToken","authHeader","startsWith","slice","bearerToken","supabase","createAdminClient","keyHash","hashApiKey","data","apiKey","error","from","select","eq","single","is_active","console","update","last_used_at","Date","toISOString","profile","profileError","user_id","userId","createServerClient","user","auth","getUser","id"],"mappings":"AAAA;;CAEC;;;;;;;;;;;QAwBqBA;eAAAA;;QAgDAC;eAAAA;;QA7DNC;eAAAA;;;uBATkB;wBACiB;yBACxB;AAOpB,SAASA,mBAAmBC,UAAmB;IACpD,IAAI,CAACA,cAAc,CAACA,WAAWC,UAAU,CAAC,YAAY;QACpD,OAAO;IACT;IACA,OAAOD,WAAWE,KAAK,CAAC;AAC1B;AAQO,eAAeL,4BAA4BM,WAAmB;IACnE,IAAI;QACF,MAAMC,WAAWC,IAAAA,wBAAiB;QAClC,MAAMC,UAAUC,IAAAA,mBAAU,EAACJ;QAE3B,8DAA8D;QAC9D,MAAM,EAAEK,MAAMC,MAAM,EAAEC,KAAK,EAAE,GAAG,MAAM,AAACN,SACpCO,IAAI,CAAC,YACLC,MAAM,CAAC,sBACPC,EAAE,CAAC,YAAYP,SACfQ,MAAM;QAET,IAAIJ,SAAS,CAACD,UAAU,CAACA,OAAOM,SAAS,EAAE;YACzCC,QAAQN,KAAK,CAAC;YACd,OAAO;QACT;QAEA,wCAAwC;QACxC,8DAA8D;QAC9D,KAAK,AAACN,SACHO,IAAI,CAAC,YACLM,MAAM,CAAC;YAAEC,cAAc,IAAIC,OAAOC,WAAW;QAAG,GAChDP,EAAE,CAAC,YAAYP;QAElB,yBAAyB;QACzB,MAAM,EAAEE,MAAMa,OAAO,EAAEX,OAAOY,YAAY,EAAE,GAAG,MAAMlB,SAClDO,IAAI,CAAC,YACLC,MAAM,CAAC,KACPC,EAAE,CAAC,MAAMJ,OAAOc,OAAO,EACvBT,MAAM;QAET,IAAIQ,gBAAgB,CAACD,SAAS;YAC5B,OAAO;QACT;QAEA,OAAO;YACLG,QAAQf,OAAOc,OAAO;YACtBF;QACF;IACF,EAAE,OAAOX,OAAO;QACdM,QAAQN,KAAK,CAAC,uCAAuCA;QACrD,OAAO;IACT;AACF;AAKO,eAAeZ;IACpB,IAAI;QACF,MAAMM,WAAW,MAAMqB,IAAAA,oBAAkB;QAEzC,MAAM,EACJjB,MAAM,EAAEkB,IAAI,EAAE,EACdhB,KAAK,EACN,GAAG,MAAMN,SAASuB,IAAI,CAACC,OAAO;QAE/B,IAAIlB,SAAS,CAACgB,MAAM;YAClB,OAAO;QACT;QAEA,MAAM,EAAElB,MAAMa,OAAO,EAAEX,OAAOY,YAAY,EAAE,GAAG,MAAMlB,SAClDO,IAAI,CAAC,YACLC,MAAM,CAAC,KACPC,EAAE,CAAC,MAAMa,KAAKG,EAAE,EAChBf,MAAM;QAET,IAAIQ,gBAAgB,CAACD,SAAS;YAC5B,OAAO;QACT;QAEA,OAAO;YACLG,QAAQE,KAAKG,EAAE;YACfR;QACF;IACF,EAAE,OAAOX,OAAO;QACdM,QAAQN,KAAK,CAAC,wCAAwCA;QACtD,OAAO;IACT;AACF"}