30949b6688babd426a45ca00f95efd39
/**
 * Bearer token authentication utilities for API routes
 */ "use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get authenticateWithBearerToken () {
        return authenticateWithBearerToken;
    },
    get authenticateWithSession () {
        return authenticateWithSession;
    },
    get extractBearerToken () {
        return extractBearerToken;
    }
});
const _admin = require("./supabase/admin");
const _server = require("./supabase/server");
const _apikeys = require("./api-keys");
function extractBearerToken(authHeader) {
    if (!authHeader || !authHeader.startsWith('Bearer ')) {
        return null;
    }
    return authHeader.slice(7);
}
async function authenticateWithBearerToken(bearerToken) {
    try {
        const supabase = (0, _admin.createAdminClient)();
        const keyHash = (0, _apikeys.hashApiKey)(bearerToken);
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        const { data: apiKey, error } = await supabase.from('api_keys').select('user_id, is_active').eq('key_hash', keyHash).single();
        if (error || !apiKey || !apiKey.is_active) {
            console.error('[Bearer Auth] Invalid or inactive API key');
            return null;
        }
        // Update last_used_at (fire and forget)
        // eslint-disable-next-line @typescript-eslint/no-explicit-any
        void supabase.from('api_keys').update({
            last_used_at: new Date().toISOString()
        }).eq('key_hash', keyHash);
        // Get the user's profile
        const { data: profile, error: profileError } = await supabase.from('profiles').select('*').eq('id', apiKey.user_id).single();
        if (profileError || !profile) {
            return null;
        }
        return {
            userId: apiKey.user_id,
            profile
        };
    } catch (error) {
        console.error('[Bearer Auth] Error authenticating:', error);
        return null;
    }
}
async function authenticateWithSession() {
    try {
        const supabase = await (0, _server.createClient)();
        const { data: { user }, error } = await supabase.auth.getUser();
        if (error || !user) {
            return null;
        }
        const { data: profile, error: profileError } = await supabase.from('profiles').select('*').eq('id', user.id).single();
        if (profileError || !profile) {
            return null;
        }
        return {
            userId: user.id,
            profile
        };
    } catch (error) {
        console.error('[Session Auth] Error authenticating:', error);
        return null;
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3Bpb3RyL0Rlc2t0b3AvZ3VpdGFyLWNybS9saWIvYmVhcmVyLWF1dGgudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBCZWFyZXIgdG9rZW4gYXV0aGVudGljYXRpb24gdXRpbGl0aWVzIGZvciBBUEkgcm91dGVzXG4gKi9cblxuaW1wb3J0IHsgY3JlYXRlQWRtaW5DbGllbnQgfSBmcm9tICdAL2xpYi9zdXBhYmFzZS9hZG1pbic7XG5pbXBvcnQgeyBjcmVhdGVDbGllbnQgYXMgY3JlYXRlU2VydmVyQ2xpZW50IH0gZnJvbSAnQC9saWIvc3VwYWJhc2Uvc2VydmVyJztcbmltcG9ydCB7IGhhc2hBcGlLZXkgfSBmcm9tICdAL2xpYi9hcGkta2V5cyc7XG5cbi8qKlxuICogRXh0cmFjdCBiZWFyZXIgdG9rZW4gZnJvbSBBdXRob3JpemF0aW9uIGhlYWRlclxuICogQHBhcmFtIGF1dGhIZWFkZXIgVGhlIEF1dGhvcml6YXRpb24gaGVhZGVyIHZhbHVlXG4gKiBAcmV0dXJucyB7c3RyaW5nIHwgbnVsbH0gVGhlIHRva2VuIG9yIG51bGwgaWYgbm90IGZvdW5kXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBleHRyYWN0QmVhcmVyVG9rZW4oYXV0aEhlYWRlcj86IHN0cmluZyk6IHN0cmluZyB8IG51bGwge1xuICBpZiAoIWF1dGhIZWFkZXIgfHwgIWF1dGhIZWFkZXIuc3RhcnRzV2l0aCgnQmVhcmVyICcpKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgcmV0dXJuIGF1dGhIZWFkZXIuc2xpY2UoNyk7XG59XG5cbi8qKlxuICogQXV0aGVudGljYXRlIGEgcmVxdWVzdCB1c2luZyBiZWFyZXIgdG9rZW5cbiAqIFJldHVybnMgdGhlIHVzZXIgSUQgYW5kIHByb2ZpbGUgaWYgYXV0aGVudGljYXRpb24gc3VjY2VlZHNcbiAqIEBwYXJhbSBiZWFyZXJUb2tlbiBUaGUgYmVhcmVyIHRva2VuIGZyb20gdGhlIEF1dGhvcml6YXRpb24gaGVhZGVyXG4gKiBAcmV0dXJucyB7UHJvbWlzZTx7dXNlcklkOiBzdHJpbmcsIHByb2ZpbGU6IGFueX0gfCBudWxsPn0gVXNlciBpbmZvIG9yIG51bGwgaWYgYXV0aGVudGljYXRpb24gZmFpbHNcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGF1dGhlbnRpY2F0ZVdpdGhCZWFyZXJUb2tlbihiZWFyZXJUb2tlbjogc3RyaW5nKSB7XG4gIHRyeSB7XG4gICAgY29uc3Qgc3VwYWJhc2UgPSBjcmVhdGVBZG1pbkNsaWVudCgpO1xuICAgIGNvbnN0IGtleUhhc2ggPSBoYXNoQXBpS2V5KGJlYXJlclRva2VuKTtcblxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZXhwbGljaXQtYW55XG4gICAgY29uc3QgeyBkYXRhOiBhcGlLZXksIGVycm9yIH0gPSBhd2FpdCAoc3VwYWJhc2UgYXMgdW5rbm93biBhcyBhbnkpXG4gICAgICAuZnJvbSgnYXBpX2tleXMnKVxuICAgICAgLnNlbGVjdCgndXNlcl9pZCwgaXNfYWN0aXZlJylcbiAgICAgIC5lcSgna2V5X2hhc2gnLCBrZXlIYXNoKVxuICAgICAgLnNpbmdsZSgpO1xuXG4gICAgaWYgKGVycm9yIHx8ICFhcGlLZXkgfHwgIWFwaUtleS5pc19hY3RpdmUpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1tCZWFyZXIgQXV0aF0gSW52YWxpZCBvciBpbmFjdGl2ZSBBUEkga2V5Jyk7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBVcGRhdGUgbGFzdF91c2VkX2F0IChmaXJlIGFuZCBmb3JnZXQpXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1leHBsaWNpdC1hbnlcbiAgICB2b2lkIChzdXBhYmFzZSBhcyB1bmtub3duIGFzIGFueSlcbiAgICAgIC5mcm9tKCdhcGlfa2V5cycpXG4gICAgICAudXBkYXRlKHsgbGFzdF91c2VkX2F0OiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgfSlcbiAgICAgIC5lcSgna2V5X2hhc2gnLCBrZXlIYXNoKTtcblxuICAgIC8vIEdldCB0aGUgdXNlcidzIHByb2ZpbGVcbiAgICBjb25zdCB7IGRhdGE6IHByb2ZpbGUsIGVycm9yOiBwcm9maWxlRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAuZnJvbSgncHJvZmlsZXMnKVxuICAgICAgLnNlbGVjdCgnKicpXG4gICAgICAuZXEoJ2lkJywgYXBpS2V5LnVzZXJfaWQpXG4gICAgICAuc2luZ2xlKCk7XG5cbiAgICBpZiAocHJvZmlsZUVycm9yIHx8ICFwcm9maWxlKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgdXNlcklkOiBhcGlLZXkudXNlcl9pZCxcbiAgICAgIHByb2ZpbGUsXG4gICAgfTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdbQmVhcmVyIEF1dGhdIEVycm9yIGF1dGhlbnRpY2F0aW5nOicsIGVycm9yKTtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxufVxuXG4vKipcbiAqIEF1dGhlbnRpY2F0ZSB1c2luZyBzZXNzaW9uIGNvb2tpZXMgKGZvciBiYWNrd2FyZCBjb21wYXRpYmlsaXR5KVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gYXV0aGVudGljYXRlV2l0aFNlc3Npb24oKSB7XG4gIHRyeSB7XG4gICAgY29uc3Qgc3VwYWJhc2UgPSBhd2FpdCBjcmVhdGVTZXJ2ZXJDbGllbnQoKTtcblxuICAgIGNvbnN0IHtcbiAgICAgIGRhdGE6IHsgdXNlciB9LFxuICAgICAgZXJyb3IsXG4gICAgfSA9IGF3YWl0IHN1cGFiYXNlLmF1dGguZ2V0VXNlcigpO1xuXG4gICAgaWYgKGVycm9yIHx8ICF1c2VyKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICBjb25zdCB7IGRhdGE6IHByb2ZpbGUsIGVycm9yOiBwcm9maWxlRXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgICAuZnJvbSgncHJvZmlsZXMnKVxuICAgICAgLnNlbGVjdCgnKicpXG4gICAgICAuZXEoJ2lkJywgdXNlci5pZClcbiAgICAgIC5zaW5nbGUoKTtcblxuICAgIGlmIChwcm9maWxlRXJyb3IgfHwgIXByb2ZpbGUpIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB1c2VySWQ6IHVzZXIuaWQsXG4gICAgICBwcm9maWxlLFxuICAgIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignW1Nlc3Npb24gQXV0aF0gRXJyb3IgYXV0aGVudGljYXRpbmc6JywgZXJyb3IpO1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG4iXSwibmFtZXMiOlsiYXV0aGVudGljYXRlV2l0aEJlYXJlclRva2VuIiwiYXV0aGVudGljYXRlV2l0aFNlc3Npb24iLCJleHRyYWN0QmVhcmVyVG9rZW4iLCJhdXRoSGVhZGVyIiwic3RhcnRzV2l0aCIsInNsaWNlIiwiYmVhcmVyVG9rZW4iLCJzdXBhYmFzZSIsImNyZWF0ZUFkbWluQ2xpZW50Iiwia2V5SGFzaCIsImhhc2hBcGlLZXkiLCJkYXRhIiwiYXBpS2V5IiwiZXJyb3IiLCJmcm9tIiwic2VsZWN0IiwiZXEiLCJzaW5nbGUiLCJpc19hY3RpdmUiLCJjb25zb2xlIiwidXBkYXRlIiwibGFzdF91c2VkX2F0IiwiRGF0ZSIsInRvSVNPU3RyaW5nIiwicHJvZmlsZSIsInByb2ZpbGVFcnJvciIsInVzZXJfaWQiLCJ1c2VySWQiLCJjcmVhdGVTZXJ2ZXJDbGllbnQiLCJ1c2VyIiwiYXV0aCIsImdldFVzZXIiLCJpZCJdLCJtYXBwaW5ncyI6IkFBQUE7O0NBRUM7Ozs7Ozs7Ozs7O1FBd0JxQkE7ZUFBQUE7O1FBZ0RBQztlQUFBQTs7UUE3RE5DO2VBQUFBOzs7dUJBVGtCO3dCQUNpQjt5QkFDeEI7QUFPcEIsU0FBU0EsbUJBQW1CQyxVQUFtQjtJQUNwRCxJQUFJLENBQUNBLGNBQWMsQ0FBQ0EsV0FBV0MsVUFBVSxDQUFDLFlBQVk7UUFDcEQsT0FBTztJQUNUO0lBQ0EsT0FBT0QsV0FBV0UsS0FBSyxDQUFDO0FBQzFCO0FBUU8sZUFBZUwsNEJBQTRCTSxXQUFtQjtJQUNuRSxJQUFJO1FBQ0YsTUFBTUMsV0FBV0MsSUFBQUEsd0JBQWlCO1FBQ2xDLE1BQU1DLFVBQVVDLElBQUFBLG1CQUFVLEVBQUNKO1FBRTNCLDhEQUE4RDtRQUM5RCxNQUFNLEVBQUVLLE1BQU1DLE1BQU0sRUFBRUMsS0FBSyxFQUFFLEdBQUcsTUFBTSxBQUFDTixTQUNwQ08sSUFBSSxDQUFDLFlBQ0xDLE1BQU0sQ0FBQyxzQkFDUEMsRUFBRSxDQUFDLFlBQVlQLFNBQ2ZRLE1BQU07UUFFVCxJQUFJSixTQUFTLENBQUNELFVBQVUsQ0FBQ0EsT0FBT00sU0FBUyxFQUFFO1lBQ3pDQyxRQUFRTixLQUFLLENBQUM7WUFDZCxPQUFPO1FBQ1Q7UUFFQSx3Q0FBd0M7UUFDeEMsOERBQThEO1FBQzlELEtBQUssQUFBQ04sU0FDSE8sSUFBSSxDQUFDLFlBQ0xNLE1BQU0sQ0FBQztZQUFFQyxjQUFjLElBQUlDLE9BQU9DLFdBQVc7UUFBRyxHQUNoRFAsRUFBRSxDQUFDLFlBQVlQO1FBRWxCLHlCQUF5QjtRQUN6QixNQUFNLEVBQUVFLE1BQU1hLE9BQU8sRUFBRVgsT0FBT1ksWUFBWSxFQUFFLEdBQUcsTUFBTWxCLFNBQ2xETyxJQUFJLENBQUMsWUFDTEMsTUFBTSxDQUFDLEtBQ1BDLEVBQUUsQ0FBQyxNQUFNSixPQUFPYyxPQUFPLEVBQ3ZCVCxNQUFNO1FBRVQsSUFBSVEsZ0JBQWdCLENBQUNELFNBQVM7WUFDNUIsT0FBTztRQUNUO1FBRUEsT0FBTztZQUNMRyxRQUFRZixPQUFPYyxPQUFPO1lBQ3RCRjtRQUNGO0lBQ0YsRUFBRSxPQUFPWCxPQUFPO1FBQ2RNLFFBQVFOLEtBQUssQ0FBQyx1Q0FBdUNBO1FBQ3JELE9BQU87SUFDVDtBQUNGO0FBS08sZUFBZVo7SUFDcEIsSUFBSTtRQUNGLE1BQU1NLFdBQVcsTUFBTXFCLElBQUFBLG9CQUFrQjtRQUV6QyxNQUFNLEVBQ0pqQixNQUFNLEVBQUVrQixJQUFJLEVBQUUsRUFDZGhCLEtBQUssRUFDTixHQUFHLE1BQU1OLFNBQVN1QixJQUFJLENBQUNDLE9BQU87UUFFL0IsSUFBSWxCLFNBQVMsQ0FBQ2dCLE1BQU07WUFDbEIsT0FBTztRQUNUO1FBRUEsTUFBTSxFQUFFbEIsTUFBTWEsT0FBTyxFQUFFWCxPQUFPWSxZQUFZLEVBQUUsR0FBRyxNQUFNbEIsU0FDbERPLElBQUksQ0FBQyxZQUNMQyxNQUFNLENBQUMsS0FDUEMsRUFBRSxDQUFDLE1BQU1hLEtBQUtHLEVBQUUsRUFDaEJmLE1BQU07UUFFVCxJQUFJUSxnQkFBZ0IsQ0FBQ0QsU0FBUztZQUM1QixPQUFPO1FBQ1Q7UUFFQSxPQUFPO1lBQ0xHLFFBQVFFLEtBQUtHLEVBQUU7WUFDZlI7UUFDRjtJQUNGLEVBQUUsT0FBT1gsT0FBTztRQUNkTSxRQUFRTixLQUFLLENBQUMsd0NBQXdDQTtRQUN0RCxPQUFPO0lBQ1Q7QUFDRiJ9