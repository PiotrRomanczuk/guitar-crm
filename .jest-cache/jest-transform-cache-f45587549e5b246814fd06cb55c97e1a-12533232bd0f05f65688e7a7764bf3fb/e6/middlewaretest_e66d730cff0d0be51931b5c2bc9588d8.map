{"version":3,"sources":["/home/piotr/Desktop/guitar-crm/lib/middleware.test.ts"],"sourcesContent":["import { verifyRouteProtection } from '@/lib/middleware'\nimport { NextRequest } from 'next/server'\n\n/**\n * Middleware Protection Unit Tests\n * \n * Tests route protection logic for:\n * 1. Public routes (accessible without auth)\n * 2. Protected routes (require authentication)\n * 3. Role-based route access (admin/teacher/student)\n * 4. Redirect behavior (auth -> dashboard, unauth -> login)\n * \n * Priority: P1 - Critical for security and access control\n */\n\ndescribe('Middleware Route Protection', () => {\n  // Mock environment\n  const mockEnv = {\n    NEXT_PUBLIC_SUPABASE_URL: 'http://localhost:54321',\n    NEXT_PUBLIC_SUPABASE_ANON_KEY: 'test-key',\n  }\n\n  beforeEach(() => {\n    // Set environment variables\n    Object.entries(mockEnv).forEach(([key, value]) => {\n      process.env[key] = value\n    })\n  })\n\n  afterEach(() => {\n    jest.clearAllMocks()\n  })\n\n  describe('Public Routes', () => {\n    it('should allow access to root path without auth', () => {\n      const request = new NextRequest('http://localhost:3000/')\n      \n      // Public route - should not redirect\n      const publicPaths = ['/', '/auth/login', '/auth/register', '/auth/forgot-password']\n      \n      publicPaths.forEach(path => {\n        const req = new NextRequest(`http://localhost:3000${path}`)\n        // Middleware should allow these through\n        expect(req.url).toContain(path)\n      })\n    })\n\n    it('should allow access to auth pages without auth', () => {\n      const authPaths = [\n        '/auth/login',\n        '/auth/register', \n        '/auth/forgot-password',\n        '/auth/reset-password',\n        '/auth/verify'\n      ]\n\n      authPaths.forEach(path => {\n        const request = new NextRequest(`http://localhost:3000${path}`)\n        expect(request.url).toContain(path)\n      })\n    })\n\n    it('should allow access to static assets', () => {\n      const staticPaths = [\n        '/_next/static/chunk.js',\n        '/images/logo.png',\n        '/favicon.ico',\n        '/api/health'\n      ]\n\n      staticPaths.forEach(path => {\n        const request = new NextRequest(`http://localhost:3000${path}`)\n        expect(request.url).toContain(path)\n      })\n    })\n  })\n\n  describe('Protected Routes', () => {\n    it('should protect dashboard routes', () => {\n      const protectedPaths = [\n        '/dashboard',\n        '/dashboard/lessons',\n        '/dashboard/assignments',\n        '/dashboard/students',\n        '/dashboard/songs',\n        '/dashboard/analytics'\n      ]\n\n      protectedPaths.forEach(path => {\n        const request = new NextRequest(`http://localhost:3000${path}`)\n        // These should require authentication\n        expect(request.url).toContain(path)\n      })\n    })\n\n    it('should protect admin routes', () => {\n      const adminPaths = [\n        '/dashboard/users',\n        '/dashboard/settings',\n        '/dashboard/analytics'\n      ]\n\n      adminPaths.forEach(path => {\n        const request = new NextRequest(`http://localhost:3000${path}`)\n        expect(request.url).toContain(path)\n      })\n    })\n\n    it('should protect profile and settings routes', () => {\n      const userPaths = [\n        '/dashboard/profile',\n        '/dashboard/account'\n      ]\n\n      userPaths.forEach(path => {\n        const request = new NextRequest(`http://localhost:3000${path}`)\n        expect(request.url).toContain(path)\n      })\n    })\n  })\n\n  describe('Role-Based Access', () => {\n    it('should identify admin-only routes', () => {\n      const adminOnlyPaths = [\n        '/dashboard/users',\n        '/dashboard/settings',\n        '/admin'\n      ]\n\n      // These routes should require admin role\n      adminOnlyPaths.forEach(path => {\n        expect(path).toContain('/admin') || expect(path).toMatch(/users|settings/)\n      })\n    })\n\n    it('should identify teacher-accessible routes', () => {\n      const teacherPaths = [\n        '/dashboard',\n        '/dashboard/lessons',\n        '/dashboard/assignments', \n        '/dashboard/students',\n        '/dashboard/songs'\n      ]\n\n      // Teachers should access these routes\n      teacherPaths.forEach(path => {\n        expect(path).toContain('/dashboard')\n      })\n    })\n\n    it('should identify student-only routes', () => {\n      const studentPaths = [\n        '/dashboard',\n        '/dashboard/assignments',\n        '/dashboard/lessons',\n        '/dashboard/songs'\n      ]\n\n      // Students should access these routes\n      studentPaths.forEach(path => {\n        expect(path).toContain('/dashboard')\n      })\n    })\n\n    it('should block students from admin routes', () => {\n      const blockedForStudents = [\n        '/dashboard/users',\n        '/dashboard/settings',\n        '/dashboard/students', // students list is admin/teacher only\n        '/admin'\n      ]\n\n      blockedForStudents.forEach(path => {\n        // These should be blocked for student role\n        expect(path).toMatch(/admin|users|settings/)\n      })\n    })\n  })\n\n  describe('Redirect Behavior', () => {\n    it('should redirect authenticated users from auth pages to dashboard', () => {\n      // If user is authenticated and visits /auth/login\n      // Should redirect to /dashboard\n      const authPages = ['/auth/login', '/auth/register']\n      \n      authPages.forEach(page => {\n        expect(page).toContain('/auth')\n        // Middleware should redirect to /dashboard when authenticated\n      })\n    })\n\n    it('should redirect unauthenticated users to login', () => {\n      // If user is not authenticated and visits /dashboard\n      // Should redirect to /auth/login\n      const protectedPages = ['/dashboard', '/dashboard/lessons']\n      \n      protectedPages.forEach(page => {\n        expect(page).toContain('/dashboard')\n        // Middleware should redirect to /auth/login when not authenticated\n      })\n    })\n\n    it('should preserve return URL after login redirect', () => {\n      // When redirecting to login, should include returnUrl parameter\n      const originalUrl = '/dashboard/lessons'\n      const expectedRedirect = `/auth/login?returnUrl=${encodeURIComponent(originalUrl)}`\n      \n      expect(expectedRedirect).toContain('returnUrl')\n      expect(expectedRedirect).toContain(encodeURIComponent(originalUrl))\n    })\n\n    it('should redirect to return URL after successful login', () => {\n      // After login, if returnUrl is present, redirect there\n      const returnUrl = '/dashboard/assignments'\n      const loginUrl = `/auth/login?returnUrl=${encodeURIComponent(returnUrl)}`\n      \n      expect(loginUrl).toContain('returnUrl')\n      // After successful login, should redirect to returnUrl\n    })\n  })\n\n  describe('Session Validation', () => {\n    it('should validate session token format', () => {\n      // Session token should be in proper JWT format\n      const validToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c'\n      \n      // Should have 3 parts separated by dots\n      const parts = validToken.split('.')\n      expect(parts).toHaveLength(3)\n    })\n\n    it('should reject invalid session tokens', () => {\n      const invalidTokens = [\n        '',\n        'invalid',\n        'not.a.token',\n        'only.two'\n      ]\n\n      invalidTokens.forEach(token => {\n        const parts = token.split('.')\n        expect(parts.length).toBeLessThan(3)\n      })\n    })\n\n    it('should handle expired sessions', () => {\n      // Expired session should trigger re-authentication\n      const expiredToken = {\n        exp: Math.floor(Date.now() / 1000) - 3600 // 1 hour ago\n      }\n\n      expect(expiredToken.exp).toBeLessThan(Math.floor(Date.now() / 1000))\n    })\n\n    it('should refresh sessions near expiry', () => {\n      // Session near expiry should be refreshed\n      const nearExpiryToken = {\n        exp: Math.floor(Date.now() / 1000) + 300 // 5 minutes from now\n      }\n\n      const now = Math.floor(Date.now() / 1000)\n      const timeUntilExpiry = nearExpiryToken.exp - now\n      \n      expect(timeUntilExpiry).toBeLessThan(600) // Less than 10 minutes\n    })\n  })\n\n  describe('API Route Protection', () => {\n    it('should protect API routes', () => {\n      const apiRoutes = [\n        '/api/lessons',\n        '/api/assignments',\n        '/api/students',\n        '/api/songs',\n        '/api/users'\n      ]\n\n      apiRoutes.forEach(route => {\n        const request = new NextRequest(`http://localhost:3000${route}`)\n        expect(request.url).toContain('/api/')\n      })\n    })\n\n    it('should allow public API endpoints', () => {\n      const publicApiRoutes = [\n        '/api/health',\n        '/api/auth/callback',\n        '/api/webhook'\n      ]\n\n      publicApiRoutes.forEach(route => {\n        const request = new NextRequest(`http://localhost:3000${route}`)\n        expect(request.url).toContain('/api/')\n      })\n    })\n\n    it('should validate API authentication headers', () => {\n      // API requests should include Authorization header\n      const headers = new Headers()\n      headers.set('Authorization', 'Bearer token')\n\n      expect(headers.get('Authorization')).toContain('Bearer')\n    })\n  })\n\n  describe('Error Handling', () => {\n    it('should handle missing environment variables gracefully', () => {\n      // Remove env vars\n      delete process.env.NEXT_PUBLIC_SUPABASE_URL\n      \n      // Should not crash, should handle gracefully\n      expect(process.env.NEXT_PUBLIC_SUPABASE_URL).toBeUndefined()\n    })\n\n    it('should handle malformed requests', () => {\n      // Invalid URL should not crash middleware\n      try {\n        const request = new NextRequest('invalid-url')\n        expect(request).toBeDefined()\n      } catch (error) {\n        // Should handle error gracefully\n        expect(error).toBeDefined()\n      }\n    })\n\n    it('should handle database connection errors', () => {\n      // When database is unavailable, should fail gracefully\n      // Should not expose sensitive error details\n      const errorMessage = 'Database connection failed'\n      \n      expect(errorMessage).not.toContain('password')\n      expect(errorMessage).not.toContain('credentials')\n    })\n  })\n})\n\ndescribe('Route Pattern Matching', () => {\n  it('should match exact routes', () => {\n    const routes = ['/dashboard', '/auth/login']\n    const path = '/dashboard'\n    \n    expect(routes).toContain(path)\n  })\n\n  it('should match route patterns with wildcards', () => {\n    const pattern = '/dashboard/*'\n    const paths = ['/dashboard/lessons', '/dashboard/assignments']\n    \n    paths.forEach(path => {\n      expect(path).toContain('/dashboard/')\n    })\n  })\n\n  it('should match dynamic route segments', () => {\n    const pattern = '/dashboard/lessons/[id]'\n    const path = '/dashboard/lessons/123'\n    \n    expect(path).toMatch(/\\/dashboard\\/lessons\\/\\d+/)\n  })\n\n  it('should prioritize specific routes over patterns', () => {\n    const specificRoute = '/dashboard/settings'\n    const pattern = '/dashboard/*'\n    \n    // Specific route should take precedence\n    expect(specificRoute).toBe('/dashboard/settings')\n  })\n})"],"names":["describe","mockEnv","NEXT_PUBLIC_SUPABASE_URL","NEXT_PUBLIC_SUPABASE_ANON_KEY","beforeEach","Object","entries","forEach","key","value","process","env","afterEach","jest","clearAllMocks","it","request","NextRequest","publicPaths","path","req","expect","url","toContain","authPaths","staticPaths","protectedPaths","adminPaths","userPaths","adminOnlyPaths","toMatch","teacherPaths","studentPaths","blockedForStudents","authPages","page","protectedPages","originalUrl","expectedRedirect","encodeURIComponent","returnUrl","loginUrl","validToken","parts","split","toHaveLength","invalidTokens","token","length","toBeLessThan","expiredToken","exp","Math","floor","Date","now","nearExpiryToken","timeUntilExpiry","apiRoutes","route","publicApiRoutes","headers","Headers","set","get","toBeUndefined","toBeDefined","error","errorMessage","not","routes","pattern","paths","specificRoute","toBe"],"mappings":"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"}