{"version":3,"sources":["/home/piotr/Desktop/guitar-crm/lib/bearer-auth.test.ts"],"sourcesContent":["/**\n * Tests for Bearer Token Authentication\n */\n\nimport { extractBearerToken } from '@/lib/bearer-auth';\nimport { generateApiKey, hashApiKey } from '@/lib/api-keys';\n\ndescribe('Bearer Token Authentication', () => {\n  describe('extractBearerToken', () => {\n    it('should extract bearer token from Authorization header', () => {\n      const token = extractBearerToken('Bearer gcrm_abc123');\n      expect(token).toBe('gcrm_abc123');\n    });\n\n    it('should return null for missing Authorization header', () => {\n      const token = extractBearerToken(undefined);\n      expect(token).toBeNull();\n    });\n\n    it('should return null for invalid Authorization header format', () => {\n      const token = extractBearerToken('Basic abc123');\n      expect(token).toBeNull();\n    });\n\n    it('should return null for header without Bearer prefix', () => {\n      const token = extractBearerToken('gcrm_abc123');\n      expect(token).toBeNull();\n    });\n  });\n\n  describe('API Key Generation and Hashing', () => {\n    it('should generate unique API keys', () => {\n      const key1 = generateApiKey();\n      const key2 = generateApiKey();\n      expect(key1).not.toBe(key2);\n    });\n\n    it('should generate keys with correct prefix', () => {\n      const key = generateApiKey();\n      expect(key).toMatch(/^gcrm_/);\n    });\n\n    it('should hash API keys consistently', () => {\n      const key = 'gcrm_test123';\n      const hash1 = hashApiKey(key);\n      const hash2 = hashApiKey(key);\n      expect(hash1).toBe(hash2);\n    });\n\n    it('should generate different hashes for different keys', () => {\n      const key1 = generateApiKey();\n      const key2 = generateApiKey();\n      const hash1 = hashApiKey(key1);\n      const hash2 = hashApiKey(key2);\n      expect(hash1).not.toBe(hash2);\n    });\n\n    it('should hash to 64 character hex string (SHA256)', () => {\n      const key = generateApiKey();\n      const hash = hashApiKey(key);\n      expect(hash).toMatch(/^[a-f0-9]{64}$/);\n    });\n  });\n});\n\ndescribe('API Key Management Routes', () => {\n  describe('GET /api/api-keys', () => {\n    it('should require authentication', async () => {\n      // Test should verify 401 response without valid session/bearer token\n    });\n\n    it(\"should return only user's own API keys\", async () => {\n      // Test should verify that users only see their own keys\n    });\n\n    it('should not include key_hash in response', async () => {\n      // Test should verify sensitive data is not exposed\n    });\n  });\n\n  describe('POST /api/api-keys', () => {\n    it('should create a new API key for authenticated user', async () => {\n      // Test should create key and verify it returns plain key once\n    });\n\n    it('should require a name parameter', async () => {\n      // Test should return 400 for missing name\n    });\n\n    it('should not return plain key in subsequent requests', async () => {\n      // Test should verify key is only shown once at creation\n    });\n\n    it('should hash the key before storing', async () => {\n      // Test should verify key_hash is stored, not plain key\n    });\n  });\n\n  describe('DELETE /api/api-keys/[id]', () => {\n    it(\"should delete only user's own API keys\", async () => {\n      // Test should verify 403 error when trying to delete others' keys\n    });\n\n    it('should return 404 for non-existent keys', async () => {\n      // Test should verify proper error handling\n    });\n\n    it('should prevent authenticated access with deleted key', async () => {\n      // Test should verify deleted key no longer works\n    });\n  });\n});\n\ndescribe('Bearer Token Usage Examples', () => {\n  it('should accept bearer token in Authorization header', async () => {\n    // Example: GET /api/songs/[id]\n    // Headers: { Authorization: 'Bearer gcrm_examplekey123' }\n    // Expected: 200 with song data\n  });\n\n  it('should reject requests with invalid bearer token', async () => {\n    // Example: GET /api/songs/[id]\n    // Headers: { Authorization: 'Bearer invalid_key' }\n    // Expected: 401 Unauthorized\n  });\n\n  it('should accept session cookies as alternative auth', async () => {\n    // Example: GET /api/songs/[id]\n    // Cookies: [valid session cookie]\n    // Expected: 200 with song data\n  });\n\n  it('should prioritize bearer token over session cookie', async () => {\n    // Example: GET /api/songs/[id]\n    // Headers: { Authorization: 'Bearer gcrm_examplekey123' }\n    // Cookies: [valid session cookie]\n    // Expected: Authenticates with bearer token\n  });\n});\n\ndescribe('Security Considerations', () => {\n  it('API keys should never be logged in plain text', () => {\n    // Ensure no console.log or error messages expose keys\n  });\n\n  it('API key hashes should use strong hashing algorithm', () => {\n    // Verify SHA256 is used, not weaker algorithms\n  });\n\n  it('RLS policies should restrict API key access', () => {\n    // Users should only see/delete their own keys\n  });\n\n  it('last_used_at should be updated on successful auth', () => {\n    // Helps users identify active vs unused keys\n  });\n\n  it('deleted keys should not grant access', () => {\n    // Verify immediate revocation\n  });\n});\n"],"names":["describe","it","token","extractBearerToken","expect","toBe","undefined","toBeNull","key1","generateApiKey","key2","not","key","toMatch","hash1","hashApiKey","hash2","hash"],"mappings":"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"}