bc5ca34b69cf0c25aa17137d6093fcbd
"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
function _export(target, all) {
    for(var name in all)Object.defineProperty(target, name, {
        enumerable: true,
        get: Object.getOwnPropertyDescriptor(all, name).get
    });
}
_export(exports, {
    get getCalendarEventsInRange () {
        return getCalendarEventsInRange;
    },
    get getGoogleAuthUrl () {
        return getGoogleAuthUrl;
    },
    get getGoogleClient () {
        return getGoogleClient;
    },
    get getGoogleOAuth2Client () {
        return getGoogleOAuth2Client;
    },
    get watchCalendar () {
        return watchCalendar;
    }
});
const _googleapis = require("googleapis");
const _server = require("./supabase/server");
const _crypto = /*#__PURE__*/ _interop_require_default(require("crypto"));
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
const getGoogleOAuth2Client = (redirectUri)=>{
    const clientId = process.env.GOOGLE_CLIENT_ID;
    const clientSecret = process.env.GOOGLE_CLIENT_SECRET;
    const uri = redirectUri || process.env.GOOGLE_REDIRECT_URI;
    if (!clientId || !clientSecret || !uri) {
        throw new Error('Missing Google OAuth2 credentials');
    }
    return new _googleapis.google.auth.OAuth2(clientId, clientSecret, uri);
};
const getGoogleAuthUrl = (redirectUri)=>{
    const oauth2Client = getGoogleOAuth2Client(redirectUri);
    const scopes = [
        'https://www.googleapis.com/auth/calendar.readonly',
        'https://www.googleapis.com/auth/userinfo.email'
    ];
    return oauth2Client.generateAuthUrl({
        access_type: 'offline',
        scope: scopes,
        prompt: 'consent'
    });
};
const getGoogleClient = async (userId)=>{
    const supabase = await (0, _server.createClient)();
    const { data: integration, error } = await supabase.from('user_integrations').select('*').eq('user_id', userId).eq('provider', 'google').single();
    if (error || !integration) {
        throw new Error('Google integration not found');
    }
    const oauth2Client = getGoogleOAuth2Client();
    oauth2Client.setCredentials({
        access_token: integration.access_token,
        refresh_token: integration.refresh_token,
        expiry_date: integration.expires_at
    });
    return oauth2Client;
};
async function getCalendarEventsInRange(userId, startDate, endDate) {
    const client = await getGoogleClient(userId);
    const calendar = _googleapis.google.calendar({
        version: 'v3',
        auth: client
    });
    const response = await calendar.events.list({
        calendarId: 'primary',
        timeMin: startDate.toISOString(),
        timeMax: endDate.toISOString(),
        singleEvents: true,
        orderBy: 'startTime'
    });
    return response.data.items || [];
}
async function watchCalendar(userId, webhookUrl) {
    const client = await getGoogleClient(userId);
    const calendar = _googleapis.google.calendar({
        version: 'v3',
        auth: client
    });
    const channelId = _crypto.default.randomUUID();
    const response = await calendar.events.watch({
        calendarId: 'primary',
        requestBody: {
            id: channelId,
            type: 'web_hook',
            address: webhookUrl
        }
    });
    return {
        channelId: response.data.id,
        resourceId: response.data.resourceId,
        expiration: response.data.expiration ? parseInt(response.data.expiration) : undefined
    };
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9ob21lL3Bpb3RyL0Rlc2t0b3AvZ3VpdGFyLWNybS9saWIvZ29vZ2xlLnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdvb2dsZSB9IGZyb20gJ2dvb2dsZWFwaXMnO1xuaW1wb3J0IHsgY3JlYXRlQ2xpZW50IH0gZnJvbSAnQC9saWIvc3VwYWJhc2Uvc2VydmVyJztcbmltcG9ydCBjcnlwdG8gZnJvbSAnY3J5cHRvJztcblxuZXhwb3J0IGNvbnN0IGdldEdvb2dsZU9BdXRoMkNsaWVudCA9IChyZWRpcmVjdFVyaT86IHN0cmluZykgPT4ge1xuICBjb25zdCBjbGllbnRJZCA9IHByb2Nlc3MuZW52LkdPT0dMRV9DTElFTlRfSUQ7XG4gIGNvbnN0IGNsaWVudFNlY3JldCA9IHByb2Nlc3MuZW52LkdPT0dMRV9DTElFTlRfU0VDUkVUO1xuICBjb25zdCB1cmkgPSByZWRpcmVjdFVyaSB8fCBwcm9jZXNzLmVudi5HT09HTEVfUkVESVJFQ1RfVVJJO1xuXG4gIGlmICghY2xpZW50SWQgfHwgIWNsaWVudFNlY3JldCB8fCAhdXJpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdNaXNzaW5nIEdvb2dsZSBPQXV0aDIgY3JlZGVudGlhbHMnKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgZ29vZ2xlLmF1dGguT0F1dGgyKGNsaWVudElkLCBjbGllbnRTZWNyZXQsIHVyaSk7XG59O1xuXG5leHBvcnQgY29uc3QgZ2V0R29vZ2xlQXV0aFVybCA9IChyZWRpcmVjdFVyaT86IHN0cmluZykgPT4ge1xuICBjb25zdCBvYXV0aDJDbGllbnQgPSBnZXRHb29nbGVPQXV0aDJDbGllbnQocmVkaXJlY3RVcmkpO1xuXG4gIGNvbnN0IHNjb3BlcyA9IFtcbiAgICAnaHR0cHM6Ly93d3cuZ29vZ2xlYXBpcy5jb20vYXV0aC9jYWxlbmRhci5yZWFkb25seScsXG4gICAgJ2h0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL2F1dGgvdXNlcmluZm8uZW1haWwnLFxuICBdO1xuXG4gIHJldHVybiBvYXV0aDJDbGllbnQuZ2VuZXJhdGVBdXRoVXJsKHtcbiAgICBhY2Nlc3NfdHlwZTogJ29mZmxpbmUnLFxuICAgIHNjb3BlOiBzY29wZXMsXG4gICAgcHJvbXB0OiAnY29uc2VudCcsXG4gIH0pO1xufTtcblxuZXhwb3J0IGludGVyZmFjZSBDYWxlbmRhckV2ZW50IHtcbiAgaWQ6IHN0cmluZztcbiAgc3VtbWFyeTogc3RyaW5nO1xuICBkZXNjcmlwdGlvbj86IHN0cmluZztcbiAgc3RhcnQ6IHsgZGF0ZVRpbWU6IHN0cmluZzsgdGltZVpvbmU/OiBzdHJpbmcgfTtcbiAgZW5kOiB7IGRhdGVUaW1lOiBzdHJpbmc7IHRpbWVab25lPzogc3RyaW5nIH07XG4gIGF0dGVuZGVlcz86IEFycmF5PHsgZW1haWw6IHN0cmluZzsgZGlzcGxheU5hbWU/OiBzdHJpbmcgfT47XG59XG5cbmV4cG9ydCBjb25zdCBnZXRHb29nbGVDbGllbnQgPSBhc3luYyAodXNlcklkOiBzdHJpbmcpID0+IHtcbiAgY29uc3Qgc3VwYWJhc2UgPSBhd2FpdCBjcmVhdGVDbGllbnQoKTtcbiAgY29uc3QgeyBkYXRhOiBpbnRlZ3JhdGlvbiwgZXJyb3IgfSA9IGF3YWl0IHN1cGFiYXNlXG4gICAgLmZyb20oJ3VzZXJfaW50ZWdyYXRpb25zJylcbiAgICAuc2VsZWN0KCcqJylcbiAgICAuZXEoJ3VzZXJfaWQnLCB1c2VySWQpXG4gICAgLmVxKCdwcm92aWRlcicsICdnb29nbGUnKVxuICAgIC5zaW5nbGUoKTtcblxuICBpZiAoZXJyb3IgfHwgIWludGVncmF0aW9uKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdHb29nbGUgaW50ZWdyYXRpb24gbm90IGZvdW5kJyk7XG4gIH1cblxuICBjb25zdCBvYXV0aDJDbGllbnQgPSBnZXRHb29nbGVPQXV0aDJDbGllbnQoKTtcblxuICBvYXV0aDJDbGllbnQuc2V0Q3JlZGVudGlhbHMoe1xuICAgIGFjY2Vzc190b2tlbjogaW50ZWdyYXRpb24uYWNjZXNzX3Rva2VuLFxuICAgIHJlZnJlc2hfdG9rZW46IGludGVncmF0aW9uLnJlZnJlc2hfdG9rZW4sXG4gICAgZXhwaXJ5X2RhdGU6IGludGVncmF0aW9uLmV4cGlyZXNfYXQsXG4gIH0pO1xuXG4gIHJldHVybiBvYXV0aDJDbGllbnQ7XG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0Q2FsZW5kYXJFdmVudHNJblJhbmdlKFxuICB1c2VySWQ6IHN0cmluZyxcbiAgc3RhcnREYXRlOiBEYXRlLFxuICBlbmREYXRlOiBEYXRlXG4pOiBQcm9taXNlPENhbGVuZGFyRXZlbnRbXT4ge1xuICBjb25zdCBjbGllbnQgPSBhd2FpdCBnZXRHb29nbGVDbGllbnQodXNlcklkKTtcbiAgY29uc3QgY2FsZW5kYXIgPSBnb29nbGUuY2FsZW5kYXIoeyB2ZXJzaW9uOiAndjMnLCBhdXRoOiBjbGllbnQgfSk7XG5cbiAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBjYWxlbmRhci5ldmVudHMubGlzdCh7XG4gICAgY2FsZW5kYXJJZDogJ3ByaW1hcnknLFxuICAgIHRpbWVNaW46IHN0YXJ0RGF0ZS50b0lTT1N0cmluZygpLFxuICAgIHRpbWVNYXg6IGVuZERhdGUudG9JU09TdHJpbmcoKSxcbiAgICBzaW5nbGVFdmVudHM6IHRydWUsXG4gICAgb3JkZXJCeTogJ3N0YXJ0VGltZScsXG4gIH0pO1xuXG4gIHJldHVybiAocmVzcG9uc2UuZGF0YS5pdGVtcyB8fCBbXSkgYXMgQ2FsZW5kYXJFdmVudFtdO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd2F0Y2hDYWxlbmRhcih1c2VySWQ6IHN0cmluZywgd2ViaG9va1VybDogc3RyaW5nKSB7XG4gIGNvbnN0IGNsaWVudCA9IGF3YWl0IGdldEdvb2dsZUNsaWVudCh1c2VySWQpO1xuICBjb25zdCBjYWxlbmRhciA9IGdvb2dsZS5jYWxlbmRhcih7IHZlcnNpb246ICd2MycsIGF1dGg6IGNsaWVudCB9KTtcblxuICBjb25zdCBjaGFubmVsSWQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpO1xuXG4gIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgY2FsZW5kYXIuZXZlbnRzLndhdGNoKHtcbiAgICBjYWxlbmRhcklkOiAncHJpbWFyeScsXG4gICAgcmVxdWVzdEJvZHk6IHtcbiAgICAgIGlkOiBjaGFubmVsSWQsXG4gICAgICB0eXBlOiAnd2ViX2hvb2snLFxuICAgICAgYWRkcmVzczogd2ViaG9va1VybCxcbiAgICB9LFxuICB9KTtcblxuICByZXR1cm4ge1xuICAgIGNoYW5uZWxJZDogcmVzcG9uc2UuZGF0YS5pZCxcbiAgICByZXNvdXJjZUlkOiByZXNwb25zZS5kYXRhLnJlc291cmNlSWQsXG4gICAgZXhwaXJhdGlvbjogcmVzcG9uc2UuZGF0YS5leHBpcmF0aW9uID8gcGFyc2VJbnQocmVzcG9uc2UuZGF0YS5leHBpcmF0aW9uKSA6IHVuZGVmaW5lZCxcbiAgfTtcbn1cbiJdLCJuYW1lcyI6WyJnZXRDYWxlbmRhckV2ZW50c0luUmFuZ2UiLCJnZXRHb29nbGVBdXRoVXJsIiwiZ2V0R29vZ2xlQ2xpZW50IiwiZ2V0R29vZ2xlT0F1dGgyQ2xpZW50Iiwid2F0Y2hDYWxlbmRhciIsInJlZGlyZWN0VXJpIiwiY2xpZW50SWQiLCJwcm9jZXNzIiwiZW52IiwiR09PR0xFX0NMSUVOVF9JRCIsImNsaWVudFNlY3JldCIsIkdPT0dMRV9DTElFTlRfU0VDUkVUIiwidXJpIiwiR09PR0xFX1JFRElSRUNUX1VSSSIsIkVycm9yIiwiZ29vZ2xlIiwiYXV0aCIsIk9BdXRoMiIsIm9hdXRoMkNsaWVudCIsInNjb3BlcyIsImdlbmVyYXRlQXV0aFVybCIsImFjY2Vzc190eXBlIiwic2NvcGUiLCJwcm9tcHQiLCJ1c2VySWQiLCJzdXBhYmFzZSIsImNyZWF0ZUNsaWVudCIsImRhdGEiLCJpbnRlZ3JhdGlvbiIsImVycm9yIiwiZnJvbSIsInNlbGVjdCIsImVxIiwic2luZ2xlIiwic2V0Q3JlZGVudGlhbHMiLCJhY2Nlc3NfdG9rZW4iLCJyZWZyZXNoX3Rva2VuIiwiZXhwaXJ5X2RhdGUiLCJleHBpcmVzX2F0Iiwic3RhcnREYXRlIiwiZW5kRGF0ZSIsImNsaWVudCIsImNhbGVuZGFyIiwidmVyc2lvbiIsInJlc3BvbnNlIiwiZXZlbnRzIiwibGlzdCIsImNhbGVuZGFySWQiLCJ0aW1lTWluIiwidG9JU09TdHJpbmciLCJ0aW1lTWF4Iiwic2luZ2xlRXZlbnRzIiwib3JkZXJCeSIsIml0ZW1zIiwid2ViaG9va1VybCIsImNoYW5uZWxJZCIsImNyeXB0byIsInJhbmRvbVVVSUQiLCJ3YXRjaCIsInJlcXVlc3RCb2R5IiwiaWQiLCJ0eXBlIiwiYWRkcmVzcyIsInJlc291cmNlSWQiLCJleHBpcmF0aW9uIiwicGFyc2VJbnQiLCJ1bmRlZmluZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O1FBZ0VzQkE7ZUFBQUE7O1FBaERUQztlQUFBQTs7UUF3QkFDO2VBQUFBOztRQXBDQUM7ZUFBQUE7O1FBK0VTQztlQUFBQTs7OzRCQW5GQzt3QkFDTTsrREFDVjs7Ozs7O0FBRVosTUFBTUQsd0JBQXdCLENBQUNFO0lBQ3BDLE1BQU1DLFdBQVdDLFFBQVFDLEdBQUcsQ0FBQ0MsZ0JBQWdCO0lBQzdDLE1BQU1DLGVBQWVILFFBQVFDLEdBQUcsQ0FBQ0csb0JBQW9CO0lBQ3JELE1BQU1DLE1BQU1QLGVBQWVFLFFBQVFDLEdBQUcsQ0FBQ0ssbUJBQW1CO0lBRTFELElBQUksQ0FBQ1AsWUFBWSxDQUFDSSxnQkFBZ0IsQ0FBQ0UsS0FBSztRQUN0QyxNQUFNLElBQUlFLE1BQU07SUFDbEI7SUFFQSxPQUFPLElBQUlDLGtCQUFNLENBQUNDLElBQUksQ0FBQ0MsTUFBTSxDQUFDWCxVQUFVSSxjQUFjRTtBQUN4RDtBQUVPLE1BQU1YLG1CQUFtQixDQUFDSTtJQUMvQixNQUFNYSxlQUFlZixzQkFBc0JFO0lBRTNDLE1BQU1jLFNBQVM7UUFDYjtRQUNBO0tBQ0Q7SUFFRCxPQUFPRCxhQUFhRSxlQUFlLENBQUM7UUFDbENDLGFBQWE7UUFDYkMsT0FBT0g7UUFDUEksUUFBUTtJQUNWO0FBQ0Y7QUFXTyxNQUFNckIsa0JBQWtCLE9BQU9zQjtJQUNwQyxNQUFNQyxXQUFXLE1BQU1DLElBQUFBLG9CQUFZO0lBQ25DLE1BQU0sRUFBRUMsTUFBTUMsV0FBVyxFQUFFQyxLQUFLLEVBQUUsR0FBRyxNQUFNSixTQUN4Q0ssSUFBSSxDQUFDLHFCQUNMQyxNQUFNLENBQUMsS0FDUEMsRUFBRSxDQUFDLFdBQVdSLFFBQ2RRLEVBQUUsQ0FBQyxZQUFZLFVBQ2ZDLE1BQU07SUFFVCxJQUFJSixTQUFTLENBQUNELGFBQWE7UUFDekIsTUFBTSxJQUFJZCxNQUFNO0lBQ2xCO0lBRUEsTUFBTUksZUFBZWY7SUFFckJlLGFBQWFnQixjQUFjLENBQUM7UUFDMUJDLGNBQWNQLFlBQVlPLFlBQVk7UUFDdENDLGVBQWVSLFlBQVlRLGFBQWE7UUFDeENDLGFBQWFULFlBQVlVLFVBQVU7SUFDckM7SUFFQSxPQUFPcEI7QUFDVDtBQUVPLGVBQWVsQix5QkFDcEJ3QixNQUFjLEVBQ2RlLFNBQWUsRUFDZkMsT0FBYTtJQUViLE1BQU1DLFNBQVMsTUFBTXZDLGdCQUFnQnNCO0lBQ3JDLE1BQU1rQixXQUFXM0Isa0JBQU0sQ0FBQzJCLFFBQVEsQ0FBQztRQUFFQyxTQUFTO1FBQU0zQixNQUFNeUI7SUFBTztJQUUvRCxNQUFNRyxXQUFXLE1BQU1GLFNBQVNHLE1BQU0sQ0FBQ0MsSUFBSSxDQUFDO1FBQzFDQyxZQUFZO1FBQ1pDLFNBQVNULFVBQVVVLFdBQVc7UUFDOUJDLFNBQVNWLFFBQVFTLFdBQVc7UUFDNUJFLGNBQWM7UUFDZEMsU0FBUztJQUNYO0lBRUEsT0FBUVIsU0FBU2pCLElBQUksQ0FBQzBCLEtBQUssSUFBSSxFQUFFO0FBQ25DO0FBRU8sZUFBZWpELGNBQWNvQixNQUFjLEVBQUU4QixVQUFrQjtJQUNwRSxNQUFNYixTQUFTLE1BQU12QyxnQkFBZ0JzQjtJQUNyQyxNQUFNa0IsV0FBVzNCLGtCQUFNLENBQUMyQixRQUFRLENBQUM7UUFBRUMsU0FBUztRQUFNM0IsTUFBTXlCO0lBQU87SUFFL0QsTUFBTWMsWUFBWUMsZUFBTSxDQUFDQyxVQUFVO0lBRW5DLE1BQU1iLFdBQVcsTUFBTUYsU0FBU0csTUFBTSxDQUFDYSxLQUFLLENBQUM7UUFDM0NYLFlBQVk7UUFDWlksYUFBYTtZQUNYQyxJQUFJTDtZQUNKTSxNQUFNO1lBQ05DLFNBQVNSO1FBQ1g7SUFDRjtJQUVBLE9BQU87UUFDTEMsV0FBV1gsU0FBU2pCLElBQUksQ0FBQ2lDLEVBQUU7UUFDM0JHLFlBQVluQixTQUFTakIsSUFBSSxDQUFDb0MsVUFBVTtRQUNwQ0MsWUFBWXBCLFNBQVNqQixJQUFJLENBQUNxQyxVQUFVLEdBQUdDLFNBQVNyQixTQUFTakIsSUFBSSxDQUFDcUMsVUFBVSxJQUFJRTtJQUM5RTtBQUNGIn0=