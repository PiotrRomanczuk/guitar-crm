{"version":3,"sources":["/home/piotr/Desktop/guitar-crm/lib/google.ts"],"sourcesContent":["import { google } from 'googleapis';\nimport { createClient } from '@/lib/supabase/server';\nimport crypto from 'crypto';\n\nexport const getGoogleOAuth2Client = (redirectUri?: string) => {\n  const clientId = process.env.GOOGLE_CLIENT_ID;\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET;\n  const uri = redirectUri || process.env.GOOGLE_REDIRECT_URI;\n\n  if (!clientId || !clientSecret || !uri) {\n    throw new Error('Missing Google OAuth2 credentials');\n  }\n\n  return new google.auth.OAuth2(clientId, clientSecret, uri);\n};\n\nexport const getGoogleAuthUrl = (redirectUri?: string) => {\n  const oauth2Client = getGoogleOAuth2Client(redirectUri);\n\n  const scopes = [\n    'https://www.googleapis.com/auth/calendar.readonly',\n    'https://www.googleapis.com/auth/userinfo.email',\n  ];\n\n  return oauth2Client.generateAuthUrl({\n    access_type: 'offline',\n    scope: scopes,\n    prompt: 'consent',\n  });\n};\n\nexport interface CalendarEvent {\n  id: string;\n  summary: string;\n  description?: string;\n  start: { dateTime: string; timeZone?: string };\n  end: { dateTime: string; timeZone?: string };\n  attendees?: Array<{ email: string; displayName?: string }>;\n}\n\nexport const getGoogleClient = async (userId: string) => {\n  const supabase = await createClient();\n  const { data: integration, error } = await supabase\n    .from('user_integrations')\n    .select('*')\n    .eq('user_id', userId)\n    .eq('provider', 'google')\n    .single();\n\n  if (error || !integration) {\n    throw new Error('Google integration not found');\n  }\n\n  const oauth2Client = getGoogleOAuth2Client();\n\n  oauth2Client.setCredentials({\n    access_token: integration.access_token,\n    refresh_token: integration.refresh_token,\n    expiry_date: integration.expires_at,\n  });\n\n  return oauth2Client;\n};\n\nexport async function getCalendarEventsInRange(\n  userId: string,\n  startDate: Date,\n  endDate: Date\n): Promise<CalendarEvent[]> {\n  const client = await getGoogleClient(userId);\n  const calendar = google.calendar({ version: 'v3', auth: client });\n\n  const response = await calendar.events.list({\n    calendarId: 'primary',\n    timeMin: startDate.toISOString(),\n    timeMax: endDate.toISOString(),\n    singleEvents: true,\n    orderBy: 'startTime',\n  });\n\n  return (response.data.items || []) as CalendarEvent[];\n}\n\nexport async function watchCalendar(userId: string, webhookUrl: string) {\n  const client = await getGoogleClient(userId);\n  const calendar = google.calendar({ version: 'v3', auth: client });\n\n  const channelId = crypto.randomUUID();\n\n  const response = await calendar.events.watch({\n    calendarId: 'primary',\n    requestBody: {\n      id: channelId,\n      type: 'web_hook',\n      address: webhookUrl,\n    },\n  });\n\n  return {\n    channelId: response.data.id,\n    resourceId: response.data.resourceId,\n    expiration: response.data.expiration ? parseInt(response.data.expiration) : undefined,\n  };\n}\n"],"names":["getCalendarEventsInRange","getGoogleAuthUrl","getGoogleClient","getGoogleOAuth2Client","watchCalendar","redirectUri","clientId","process","env","GOOGLE_CLIENT_ID","clientSecret","GOOGLE_CLIENT_SECRET","uri","GOOGLE_REDIRECT_URI","Error","google","auth","OAuth2","oauth2Client","scopes","generateAuthUrl","access_type","scope","prompt","userId","supabase","createClient","data","integration","error","from","select","eq","single","setCredentials","access_token","refresh_token","expiry_date","expires_at","startDate","endDate","client","calendar","version","response","events","list","calendarId","timeMin","toISOString","timeMax","singleEvents","orderBy","items","webhookUrl","channelId","crypto","randomUUID","watch","requestBody","id","type","address","resourceId","expiration","parseInt","undefined"],"mappings":";;;;;;;;;;;QAgEsBA;eAAAA;;QAhDTC;eAAAA;;QAwBAC;eAAAA;;QApCAC;eAAAA;;QA+ESC;eAAAA;;;4BAnFC;wBACM;+DACV;;;;;;AAEZ,MAAMD,wBAAwB,CAACE;IACpC,MAAMC,WAAWC,QAAQC,GAAG,CAACC,gBAAgB;IAC7C,MAAMC,eAAeH,QAAQC,GAAG,CAACG,oBAAoB;IACrD,MAAMC,MAAMP,eAAeE,QAAQC,GAAG,CAACK,mBAAmB;IAE1D,IAAI,CAACP,YAAY,CAACI,gBAAgB,CAACE,KAAK;QACtC,MAAM,IAAIE,MAAM;IAClB;IAEA,OAAO,IAAIC,kBAAM,CAACC,IAAI,CAACC,MAAM,CAACX,UAAUI,cAAcE;AACxD;AAEO,MAAMX,mBAAmB,CAACI;IAC/B,MAAMa,eAAef,sBAAsBE;IAE3C,MAAMc,SAAS;QACb;QACA;KACD;IAED,OAAOD,aAAaE,eAAe,CAAC;QAClCC,aAAa;QACbC,OAAOH;QACPI,QAAQ;IACV;AACF;AAWO,MAAMrB,kBAAkB,OAAOsB;IACpC,MAAMC,WAAW,MAAMC,IAAAA,oBAAY;IACnC,MAAM,EAAEC,MAAMC,WAAW,EAAEC,KAAK,EAAE,GAAG,MAAMJ,SACxCK,IAAI,CAAC,qBACLC,MAAM,CAAC,KACPC,EAAE,CAAC,WAAWR,QACdQ,EAAE,CAAC,YAAY,UACfC,MAAM;IAET,IAAIJ,SAAS,CAACD,aAAa;QACzB,MAAM,IAAId,MAAM;IAClB;IAEA,MAAMI,eAAef;IAErBe,aAAagB,cAAc,CAAC;QAC1BC,cAAcP,YAAYO,YAAY;QACtCC,eAAeR,YAAYQ,aAAa;QACxCC,aAAaT,YAAYU,UAAU;IACrC;IAEA,OAAOpB;AACT;AAEO,eAAelB,yBACpBwB,MAAc,EACde,SAAe,EACfC,OAAa;IAEb,MAAMC,SAAS,MAAMvC,gBAAgBsB;IACrC,MAAMkB,WAAW3B,kBAAM,CAAC2B,QAAQ,CAAC;QAAEC,SAAS;QAAM3B,MAAMyB;IAAO;IAE/D,MAAMG,WAAW,MAAMF,SAASG,MAAM,CAACC,IAAI,CAAC;QAC1CC,YAAY;QACZC,SAAST,UAAUU,WAAW;QAC9BC,SAASV,QAAQS,WAAW;QAC5BE,cAAc;QACdC,SAAS;IACX;IAEA,OAAQR,SAASjB,IAAI,CAAC0B,KAAK,IAAI,EAAE;AACnC;AAEO,eAAejD,cAAcoB,MAAc,EAAE8B,UAAkB;IACpE,MAAMb,SAAS,MAAMvC,gBAAgBsB;IACrC,MAAMkB,WAAW3B,kBAAM,CAAC2B,QAAQ,CAAC;QAAEC,SAAS;QAAM3B,MAAMyB;IAAO;IAE/D,MAAMc,YAAYC,eAAM,CAACC,UAAU;IAEnC,MAAMb,WAAW,MAAMF,SAASG,MAAM,CAACa,KAAK,CAAC;QAC3CX,YAAY;QACZY,aAAa;YACXC,IAAIL;YACJM,MAAM;YACNC,SAASR;QACX;IACF;IAEA,OAAO;QACLC,WAAWX,SAASjB,IAAI,CAACiC,EAAE;QAC3BG,YAAYnB,SAASjB,IAAI,CAACoC,UAAU;QACpCC,YAAYpB,SAASjB,IAAI,CAACqC,UAAU,GAAGC,SAASrB,SAASjB,IAAI,CAACqC,UAAU,IAAIE;IAC9E;AACF"}