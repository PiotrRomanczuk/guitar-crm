{"version":3,"sources":["/home/piotr/Desktop/guitar-crm/lib/google.test.ts"],"sourcesContent":["import {\n  getGoogleOAuth2Client,\n  getGoogleAuthUrl,\n  getGoogleClient,\n  getCalendarEventsInRange,\n} from '@/lib/google';\nimport { google } from 'googleapis';\nimport { createClient } from '@/lib/supabase/server';\n\n// Mock dependencies\njest.mock('googleapis', () => {\n  const mOAuth2Client = {\n    generateAuthUrl: jest\n      .fn()\n      .mockReturnValue('https://accounts.google.com/o/oauth2/v2/auth?mock=true'),\n    setCredentials: jest.fn(),\n  };\n  return {\n    google: {\n      auth: {\n        OAuth2: jest.fn(() => mOAuth2Client),\n      },\n      calendar: jest.fn().mockReturnValue({\n        events: {\n          list: jest.fn(),\n        },\n      }),\n    },\n  };\n});\n\njest.mock('@/lib/supabase/server', () => ({\n  createClient: jest.fn(),\n}));\n\ndescribe('Google Library', () => {\n  const OLD_ENV = process.env;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    process.env = { ...OLD_ENV };\n    process.env.GOOGLE_CLIENT_ID = 'mock-client-id';\n    process.env.GOOGLE_CLIENT_SECRET = 'mock-client-secret';\n    process.env.GOOGLE_REDIRECT_URI = 'http://localhost:3000/api/oauth2/callback';\n  });\n\n  afterAll(() => {\n    process.env = OLD_ENV;\n  });\n\n  describe('getGoogleOAuth2Client', () => {\n    it('should create an OAuth2 client with correct credentials', () => {\n      getGoogleOAuth2Client();\n      expect(google.auth.OAuth2).toHaveBeenCalledWith(\n        'mock-client-id',\n        'mock-client-secret',\n        'http://localhost:3000/api/oauth2/callback'\n      );\n    });\n\n    it('should throw error if credentials are missing', () => {\n      delete process.env.GOOGLE_CLIENT_ID;\n      expect(() => getGoogleOAuth2Client()).toThrow('Missing Google OAuth2 credentials');\n    });\n  });\n\n  describe('getGoogleAuthUrl', () => {\n    it('should generate a valid auth URL', () => {\n      const url = getGoogleAuthUrl();\n      expect(url).toBe('https://accounts.google.com/o/oauth2/v2/auth?mock=true');\n\n      // Get the mock instance to check generateAuthUrl arguments\n      const mockOAuth2Client = (google.auth.OAuth2 as unknown as jest.Mock).mock.results[0].value;\n      expect(mockOAuth2Client.generateAuthUrl).toHaveBeenCalledWith({\n        access_type: 'offline',\n        scope: [\n          'https://www.googleapis.com/auth/calendar.readonly',\n          'https://www.googleapis.com/auth/userinfo.email',\n        ],\n        prompt: 'consent',\n      });\n    });\n  });\n\n  describe('getGoogleClient', () => {\n    it('should return an authenticated client when integration exists', async () => {\n      const mockSupabase = {\n        from: jest.fn().mockReturnThis(),\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockReturnThis(),\n        single: jest.fn().mockResolvedValue({\n          data: {\n            access_token: 'mock-access-token',\n            refresh_token: 'mock-refresh-token',\n            expires_at: 1234567890,\n          },\n          error: null,\n        }),\n      };\n      (createClient as jest.Mock).mockResolvedValue(mockSupabase);\n\n      const client = await getGoogleClient('user-123');\n\n      expect(client.setCredentials).toHaveBeenCalledWith({\n        access_token: 'mock-access-token',\n        refresh_token: 'mock-refresh-token',\n        expiry_date: 1234567890,\n      });\n    });\n\n    it('should throw error when integration is not found', async () => {\n      const mockSupabase = {\n        from: jest.fn().mockReturnThis(),\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockReturnThis(),\n        single: jest.fn().mockResolvedValue({\n          data: null,\n          error: { message: 'Not found' },\n        }),\n      };\n      (createClient as jest.Mock).mockResolvedValue(mockSupabase);\n\n      await expect(getGoogleClient('user-123')).rejects.toThrow('Google integration not found');\n    });\n  });\n\n  describe('getCalendarEventsInRange', () => {\n    it('should fetch events from Google Calendar', async () => {\n      // Mock getGoogleClient behavior internally since we can't easily mock the exported function within the same module\n      // However, we can mock the dependencies it uses (Supabase) which we already did.\n\n      const mockSupabase = {\n        from: jest.fn().mockReturnThis(),\n        select: jest.fn().mockReturnThis(),\n        eq: jest.fn().mockReturnThis(),\n        single: jest.fn().mockResolvedValue({\n          data: {\n            access_token: 'mock-access-token',\n          },\n          error: null,\n        }),\n      };\n      (createClient as jest.Mock).mockResolvedValue(mockSupabase);\n\n      const mockList = jest.fn().mockResolvedValue({\n        data: {\n          items: [{ id: 'event-1', summary: 'Lesson 1' }],\n        },\n      });\n\n      (google.calendar as unknown as jest.Mock).mockReturnValue({\n        events: {\n          list: mockList,\n        },\n      });\n\n      const startDate = new Date('2023-01-01');\n      const endDate = new Date('2023-01-31');\n\n      const events = await getCalendarEventsInRange('user-123', startDate, endDate);\n\n      expect(events).toHaveLength(1);\n      expect(events[0].id).toBe('event-1');\n      expect(mockList).toHaveBeenCalledWith({\n        calendarId: 'primary',\n        timeMin: startDate.toISOString(),\n        timeMax: endDate.toISOString(),\n        singleEvents: true,\n        orderBy: 'startTime',\n      });\n    });\n  });\n});\n"],"names":["jest","mock","mOAuth2Client","generateAuthUrl","fn","mockReturnValue","setCredentials","google","auth","OAuth2","calendar","events","list","createClient","describe","OLD_ENV","process","env","beforeEach","clearAllMocks","GOOGLE_CLIENT_ID","GOOGLE_CLIENT_SECRET","GOOGLE_REDIRECT_URI","afterAll","it","getGoogleOAuth2Client","expect","toHaveBeenCalledWith","toThrow","url","getGoogleAuthUrl","toBe","mockOAuth2Client","results","value","access_type","scope","prompt","mockSupabase","from","mockReturnThis","select","eq","single","mockResolvedValue","data","access_token","refresh_token","expires_at","error","client","getGoogleClient","expiry_date","message","rejects","mockList","items","id","summary","startDate","Date","endDate","getCalendarEventsInRange","toHaveLength","calendarId","timeMin","toISOString","timeMax","singleEvents","orderBy"],"mappings":"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"}