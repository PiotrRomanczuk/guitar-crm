# Database Implementation Audit

This document analyzes the alignment between the consolidated database schema and the codebase implementation.

## Summary

| Category | Status | Details |
|----------|--------|---------|
| **Existing Tables** | âœ… Aligned | 13 tables in DB, all have TypeScript types |
| **New Tables** | âš ï¸ Not Used | `student_song_progress`, `practice_sessions` have no API routes |
| **Soft Delete** | âš ï¸ Partial | `songs` uses it, `lessons`/`assignments` don't use new `deleted_at` |
| **Full-Text Search** | âš ï¸ Not Used | `search_vector` column exists but no code uses it |
| **Missing Tables** | ðŸ”´ Code References Missing Tables | `user_favorites`, `lesson_templates`, `teacher_availability` |
| **TypeScript Types** | âš ï¸ Outdated | Two type files with discrepancies |

---

## 1. Tables in Database (Consolidated Migrations)

| Table | TypeScript Types | API Usage | Status |
|-------|------------------|-----------|--------|
| `profiles` | âœ… Both files | âœ… Used extensively | âœ… OK |
| `user_roles` | âœ… `database.types.ts` | âœ… Used | âœ… OK |
| `songs` | âœ… Both files | âœ… Used extensively | âœ… OK |
| `lessons` | âœ… Both files | âœ… Used extensively | âœ… OK |
| `lesson_songs` | âœ… Both files | âœ… Used | âœ… OK |
| `assignments` | âœ… `database.types.ts` | âœ… Used | âœ… OK |
| `assignment_templates` | âœ… `database.types.ts` | âš ï¸ No API routes | âš ï¸ Unused |
| `api_keys` | âœ… Implicit | âœ… Used in auth | âœ… OK |
| `user_integrations` | âœ… Both files | âœ… Used for OAuth | âœ… OK |
| `webhook_subscriptions` | âœ… Both files | âœ… Used for Google Calendar | âœ… OK |
| `practice_sessions` | âŒ Not typed | âŒ No API routes | âš ï¸ NEW - Not implemented |
| `song_status_history` | âŒ Not typed | âœ… Used | âš ï¸ Missing types |
| `student_song_progress` | âŒ Not typed | âŒ No API routes | âš ï¸ NEW - Not implemented |

---

## 2. Tables Referenced in Code But NOT in Database

These tables are queried in the codebase but do NOT exist in the consolidated migrations:

| Table | Code Location | Status | Action Required |
|-------|---------------|--------|-----------------|
| `user_favorites` | `app/api/song/favorites/route.ts`, `app/api/song/admin-favorites/route.ts` | ðŸ”´ **MISSING** | Create migration or remove feature |
| `lesson_templates` | `app/api/lessons/templates/route.ts` | ðŸ”´ **MISSING** | Create migration or remove feature |
| `teacher_availability` | `app/api/lessons/schedule/route.ts` | ðŸ”´ **MISSING** | Create migration or remove feature |
| `task_management` | `lib/supabase/credentials.test.ts` | âš ï¸ Legacy | Update tests (table renamed to `assignments`) |

---

## 3. TypeScript Type Files Comparison

There are **two type files** that need reconciliation:

### `/database.types.ts` (Root - Auto-generated by Supabase)
- âœ… Up-to-date with actual database schema
- âœ… Contains: `assignments`, `assignment_templates`, `lesson_songs`, `lessons`, `profiles`, `songs`, `user_integrations`, `user_roles`
- âœ… Contains Views: `lesson_counts_per_student`, `lesson_counts_per_teacher`, `song_usage_stats`, `user_overview`
- âœ… Contains Enums: All 7 enums
- âŒ Missing: `api_keys`, `webhook_subscriptions`, `practice_sessions`, `song_status_history`, `student_song_progress`

### `/types/database.types.ts` (Manual/Legacy)
- âš ï¸ Outdated schema definitions
- âŒ Has legacy tables: `user_favorites`, `task_management`, `lesson_templates`, `teacher_availability`
- âš ï¸ Different column names: `isStudent` vs `is_student`, `firstName` vs `full_name`
- âš ï¸ Different types: `id: number` vs `id: string` for profiles

### Recommendation
1. **Delete** `/types/database.types.ts` (legacy)
2. **Regenerate** `/database.types.ts` with: `npx supabase gen types typescript --local > database.types.ts`
3. **Update imports** throughout codebase to use root `database.types.ts`

---

## 4. New Features Not Yet Implemented in Code

### 4.1 `student_song_progress` Table (NEW)
- **Purpose**: Track overall student progress on songs across lessons
- **Columns**: `student_id`, `song_id`, `current_status`, `started_at`, `mastered_at`, `total_practice_time_minutes`, `practice_session_count`, `difficulty_rating`, `notes`
- **Status**: âŒ No API routes, no TypeScript types, no UI

**To implement:**
- Create API route: `app/api/student/progress/route.ts`
- Add types to `database.types.ts`
- Create dashboard component for student progress

### 4.2 `practice_sessions` Table
- **Purpose**: Track individual practice sessions
- **Columns**: `id`, `student_id`, `song_id`, `duration_minutes`, `notes`, `practiced_at`
- **Status**: âŒ No API routes, no TypeScript types, no UI

**To implement:**
- Create API route: `app/api/student/practice/route.ts`
- Add types to `database.types.ts`
- Create practice logging UI

### 4.3 Full-Text Search (`search_vector`)
- **Purpose**: Fast song search by title/author
- **Column**: `songs.search_vector` (tsvector, auto-generated)
- **Status**: âŒ Not used in any queries

**Current song search uses:**
```typescript
// app/api/song/handlers.ts
dbQuery = dbQuery.ilike('title', `%${search}%`);
```

**Should use:**
```typescript
dbQuery = dbQuery.textSearch('search_vector', search, { type: 'websearch' });
```

### 4.4 Soft Delete on `lessons` and `assignments`
- **Column**: `deleted_at` added but not used
- **Current behavior**: Hard delete
- **Status**: âš ï¸ Column exists but code uses hard delete

---

## 5. Soft Delete Implementation Status

| Table | `deleted_at` Column | Code Uses Soft Delete | RLS Filters `deleted_at` |
|-------|--------------------|-----------------------|--------------------------|
| `songs` | âœ… Yes | âœ… Yes | âœ… Yes |
| `lessons` | âœ… Yes (new) | âŒ No (hard delete) | âŒ No |
| `assignments` | âœ… Yes (new) | âŒ No (hard delete) | âŒ No |

**Files using hard delete:**
- `app/api/lessons/handlers.ts:430` - `supabase.from('lessons').delete().eq('id', id)`
- `app/api/assignments/[id]/handlers.ts:226` - `supabase.from('assignments').delete().eq('id', assignmentId)`

---

## 6. Enum Alignment

| Enum | Database | TypeScript | Status |
|------|----------|------------|--------|
| `user_role` | âœ… `admin`, `teacher`, `student` | âœ… Matches | âœ… OK |
| `lesson_status` | âœ… 5 values | âœ… Matches | âœ… OK |
| `lesson_song_status` | âœ… 5 values | âœ… Matches | âœ… OK |
| `assignment_status` | âœ… 5 values | âœ… Matches | âœ… OK |
| `difficulty_level` | âœ… 3 values | âœ… Matches | âœ… OK |
| `music_key` | âœ… 31 values | âœ… Matches | âœ… OK |
| `task_priority` | âŒ REMOVED from DB | âš ï¸ Still in types | âš ï¸ Remove from types |
| `task_status` | âŒ REMOVED from DB | âš ï¸ Still in types | âš ï¸ Remove from types |

---

## 7. Missing RLS Policies

All core tables have RLS enabled and policies defined. New tables also have policies:

| Table | RLS Enabled | Policies Defined |
|-------|-------------|------------------|
| `student_song_progress` | âœ… Yes | âœ… 6 policies |
| `practice_sessions` | âœ… Yes | âœ… Policies from original |

---

## 8. Action Items

### Critical (Breaking Issues)
1. **Create migrations for missing tables** or remove dead code:
   - `user_favorites`
   - `lesson_templates`  
   - `teacher_availability`

### High Priority
2. **Regenerate TypeScript types**: `npx supabase gen types typescript --local > database.types.ts`
3. **Update imports** to use single type file
4. **Fix test file** `lib/supabase/credentials.test.ts` - references `task_management`

### Medium Priority
5. **Implement soft delete** for lessons and assignments
6. **Use full-text search** in song queries
7. **Build UI** for `student_song_progress` and `practice_sessions`

### Low Priority
8. **Remove legacy enums** from TypeScript types (`task_priority`, `task_status`)
9. **Document API routes** for new tables

---

## 9. Files to Update

| File | Issue | Fix |
|------|-------|-----|
| `/types/database.types.ts` | Outdated, conflicts with root | Delete |
| `/lib/supabase/credentials.test.ts` | References `task_management` | Update to `assignments` |
| `/app/api/song/favorites/route.ts` | Missing table | Create migration |
| `/app/api/lessons/templates/route.ts` | Missing table | Create migration |
| `/app/api/lessons/schedule/route.ts` | Missing table | Create migration |
| `/app/api/lessons/handlers.ts` | Uses hard delete | Use soft delete |
| `/app/api/assignments/[id]/handlers.ts` | Uses hard delete | Use soft delete |
| `/app/api/song/handlers.ts` | Uses ILIKE | Use full-text search |

---

*Generated: January 5, 2026*
*Branch: feature/database-migration-cleanup*
