# BMS-44: Fix for Supabase PostgREST Lesson Update Bug

## Problem Summary

The E2E test for lesson updates was failing with the error:
```
"operator does not exist: jsonb - jsonb"
```

This PostgREST error was blocking all lesson UPDATE operations in the application.

## Root Cause Analysis

### Issue 1: Database Schema Mismatch
- **Database Migration (008_table_lessons.sql)**: Defines column as `lesson_number`
- **TypeScript Types**: Reference column as `lesson_teacher_number`
- **Application Code**: Uses `lesson_teacher_number` (37 files)

The database had `lesson_number` but all application code expected `lesson_teacher_number`, causing PostgREST to receive fields that don't exist in the actual database schema.

### Issue 2: Auto-Generated Fields in Updates
The `prepareLessonForDb()` function was not filtering out auto-generated fields:
- `lesson_number` / `lesson_teacher_number` - Auto-set by database trigger
- `creator_user_id` - Field doesn't exist in database schema
- These fields were being sent in UPDATE payloads, causing PostgREST errors

### Issue 3: Role-Based Query Issues
Minor: The `getTeacherStudentIds()` function was including soft-deleted lessons when determining which students a teacher can access.

## Solution Implemented

### 1. Database Schema Migration
Created two new migrations to align database with application code:

**Migration 030**: Rename column from `lesson_number` to `lesson_teacher_number`
```sql
ALTER TABLE lessons
RENAME COLUMN lesson_number TO lesson_teacher_number;

ALTER TABLE lessons
DROP CONSTRAINT IF EXISTS uq_lessons_number;

ALTER TABLE lessons
ADD CONSTRAINT uq_lessons_teacher_number UNIQUE (teacher_id, student_id, lesson_teacher_number);
```

**Migration 031**: Update the trigger function to use new column name
```sql
CREATE OR REPLACE FUNCTION set_lesson_number()
RETURNS TRIGGER AS $$
DECLARE
    next_number INTEGER;
BEGIN
    SELECT COALESCE(MAX(lesson_teacher_number), 0) + 1 INTO next_number
    FROM lessons
    WHERE teacher_id = NEW.teacher_id
    AND student_id = NEW.student_id;

    NEW.lesson_teacher_number := next_number;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 2. Enhanced Field Filtering
Updated `app/api/lessons/utils.ts` - `prepareLessonForDb()` function to remove:
- `lesson_number` (old column name, for safety)
- `lesson_teacher_number` (auto-generated by trigger)
- `creator_user_id` (doesn't exist in database)
- All `undefined` values (prevents JSONB operator errors)

```typescript
// Remove auto-generated fields that are set by database triggers
delete dbData.lesson_number;
delete dbData.lesson_teacher_number;

// Remove fields that don't exist in the actual database schema
delete dbData.creator_user_id;
```

### 3. Improved Role-Based Filtering
Updated `getTeacherStudentIds()` to exclude soft-deleted lessons:
```typescript
const { data } = await supabase
  .from('lessons')
  .select('student_id')
  .eq('teacher_id', teacherId)
  .is('deleted_at', null);  // Only active lessons
```

## Files Changed

### Migrations
- `supabase/migrations/030_rename_lesson_number.sql` (NEW)
- `supabase/migrations/031_fix_lesson_number_trigger.sql` (NEW)

### Application Code
- `app/api/lessons/utils.ts` - Enhanced `prepareLessonForDb()`
- `app/api/lessons/handlers.ts` - Fixed `getTeacherStudentIds()`
- `app/api/lessons/create/route.ts` - Updated to use profile boolean flags
- `app/api/lessons/stats/route.ts` - Updated to use profile boolean flags

## Testing Instructions

### 1. Apply Migrations
```bash
# Local database
npx supabase migration up --local

# Or for remote database
npx supabase db push
```

### 2. Run E2E Tests
```bash
# Run the previously failing test
npm run cypress:run -- --spec "tests/e2e/lessons/teacher/lesson-crud.spec.ts"
```

### 3. Manual Testing
1. Login as teacher (p.romanczuk@gmail.com / test123_admin)
2. Navigate to `/dashboard/lessons`
3. Create a new lesson
4. Edit the lesson (update title and notes)
5. Verify changes are saved without errors
6. Check browser console and network tab for any errors

### 4. Verify Database
```sql
-- Check column name
\d lessons

-- Verify constraint exists
SELECT conname FROM pg_constraint WHERE conrelid = 'lessons'::regclass;

-- Test trigger
INSERT INTO lessons (teacher_id, student_id, scheduled_at, status)
VALUES (...);
-- Should auto-set lesson_teacher_number
```

## Expected Behavior After Fix

✅ Lesson updates should work without PostgREST errors
✅ Auto-generated fields are never sent in UPDATE requests
✅ Teachers only see active (non-deleted) student lessons
✅ E2E test `tests/e2e/lessons/teacher/lesson-crud.spec.ts` should pass

## Rollback Plan

If issues occur after deployment:

1. Revert migrations 030 and 031:
```sql
ALTER TABLE lessons RENAME COLUMN lesson_teacher_number TO lesson_number;
-- Then restore original trigger
```

2. Revert code changes:
```bash
git revert <commit-hash>
```

## Related Issues

- Linear: BMS-44
- Related to: Google Calendar sync feature (uses lesson updates)
- Blocked: E2E test suite completion

## Notes

- This fix aligns the database with 37 files of existing application code
- Alternative would have been to rename `lesson_teacher_number` → `lesson_number` in 37 files
- Chose to fix database schema to minimize code changes and maintain consistency
- The field filtering in `prepareLessonForDb()` adds an extra safety layer
